# User Story 18.3.1: Complete Agency Edit Workflow

## Story Title
Enable Agency Listing Editing with Version Control and Review Process

## Story ID
18.3.1 (Sub-story of 18.3 - Agency Management Dashboard)

## User Story
As an **agency administrator**,  
I want to **edit my agency listing details through a clear workflow**,  
So that **I can keep my agency information current and accurate while maintaining approval status**.

## Story Context
- **Parent Story:** 18.3 - Agency Management Dashboard
- **Dependencies:** Versioning system (✅), Draft API (✅), Admin approval system (✅)
- **Blocker Status:** Currently blocking full completion of Epic 18
- **Priority:** HIGH - Critical gap in user journey

## Acceptance Criteria

### 1. Edit Agency Listing Button
- [ ] Add "Edit Agency Listing" button on `/agents/settings` page
- [ ] Button placement: Top right of agency details section
- [ ] Button styling: Primary action button with edit icon
- [ ] Only visible to agency admins (not regular members)
- [ ] Disabled state with tooltip if agency has pending changes under review

### 2. Edit Form Interface
- [ ] Create `/agents/settings/edit` route for editing interface
- [ ] Reuse wizard components from agency creation for consistency:
  - [ ] Basic Information (name, website, phone)
  - [ ] Logo & Branding 
  - [ ] Coverage Areas & Specialisms
  - [ ] Team Members management
- [ ] Pre-populate all fields with current agency data
- [ ] Show current approval status badge (Approved/Pending/Draft)

### 3. Auto-Save Draft Functionality
- [ ] Auto-save changes every 30 seconds (already implemented in backend)
- [ ] Visual indicator when saving: "Saving..." → "Saved"
- [ ] Prevent navigation without saving with unsaved changes warning
- [ ] Draft indicator showing "Unsaved changes" or "All changes saved"

### 4. Submit for Review Process
- [ ] "Submit for Review" button (prominent, green)
- [ ] Pre-submission checklist:
  - [ ] All required fields completed
  - [ ] At least one team member added
  - [ ] Logo uploaded
  - [ ] Coverage areas defined
- [ ] Confirmation modal:
  ```
  Title: "Submit Changes for Review?"
  Body: "Your changes will be reviewed by our team. Your current 
        listing will remain active until changes are approved."
  Actions: [Cancel] [Submit for Review]
  ```
- [ ] Success message: "Changes submitted successfully. You'll be notified once reviewed."

### 5. Edit Restrictions & States

#### For Approved Agencies:
- [ ] Edits create new draft version
- [ ] Current approved version remains public
- [ ] Show banner: "Your approved listing is live. Changes will require review."

#### For Pending Agencies:
- [ ] Can edit and update the pending version
- [ ] Show banner: "Your agency is under review. You can still make changes."

#### For Draft Agencies:
- [ ] Direct editing without version creation
- [ ] Show banner: "Complete your agency listing and submit for review."

#### For Rejected Agencies:
- [ ] Can edit and resubmit
- [ ] Show rejection reason and required corrections
- [ ] Banner: "Address the feedback below and resubmit for review."

### 6. API Integration
- [ ] `PUT /api/agencies/[id]/draft` - Save draft changes
- [ ] `POST /api/agencies/[id]/submit-review` - Submit draft for review
- [ ] `DELETE /api/agencies/[id]/draft` - Discard draft changes

### 7. Premium Visual Design
- [ ] Maintain violet-to-blue gradient theme from creation flow
- [ ] Implement micro-interactions for form fields (focus glow, validation checkmarks)
- [ ] Add loading skeletons for initial data population
- [ ] Smooth transitions between wizard steps (slide animations)
- [ ] Enhanced button styling with gradient backgrounds and hover effects
- [ ] Auto-save indicator with micro-interactions (pulse, checkmark animations)

### 8. Mobile-Optimized Experience  
- [ ] Sticky header with save/cancel actions
- [ ] Swipeable step navigation for mobile
- [ ] Touch-friendly form controls (minimum 44px touch targets)
- [ ] Bottom action bar for primary actions
- [ ] Responsive layout adapting wizard steps for smaller screens

### 9. Error Prevention & Recovery
- [ ] Inline validation with helpful error messages
- [ ] Confirmation dialog when navigating away with unsaved changes
- [ ] Network error recovery with retry mechanisms
- [ ] Graceful degradation when auto-save fails
- [ ] Clear visual feedback for validation states (success, warning, error)

### 10. Status Communication
- [ ] Clear visual distinction between current live version and draft
- [ ] Progress indicators during form submission
- [ ] Success confirmation with next steps
- [ ] Draft expiration warnings (if applicable)
- [ ] Edit mode header showing current agency status and context

### 11. Navigation & User Flow
```
/agents/settings → [Edit Agency Listing] → /agents/settings/edit
                                         ↓
                            [Auto-save drafts every 30s]
                                         ↓
                    [Submit for Review] → Enhanced Confirmation Modal
                                         ↓
                    Success → Return to /agents/settings
```

## Technical Implementation

### Components to Create:
```typescript
// New components with premium UX
- /components/agency/EditAgencyButton.tsx          // Enhanced gradient button
- /components/agency/AgencyEditForm.tsx            // Edit form with wizard integration  
- /components/agency/SubmitReviewModal.tsx         // Enhanced confirmation modal
- /components/agency/AutoSaveIndicator.tsx         // Micro-interaction save status
- /components/agency/EditModeHeader.tsx            // Context-aware header
- /components/agency/AgencyPreviewPanel.tsx        // Side-by-side preview (desktop)
- /components/agency/MobileEditInterface.tsx       // Mobile-optimized experience
- /app/agents/settings/edit/page.tsx               // Edit page with premium layout

// Enhanced wizard components
- /components/agency/wizard-steps/* (reuse with edit-mode enhancements)
- /components/agency/EditModeProgress.tsx          // Progress indicator for edit context
- /components/agency/ValidationChecklist.tsx      // Pre-submission validation
```

### API Endpoints to Create:
```typescript
// New endpoint for submitting review
POST /api/agencies/[id]/submit-review
{
  versionId: string
}
```

### Database Updates:
```sql
-- Add to agency_versions table (if not exists)
ALTER TABLE agency_versions 
ADD COLUMN IF NOT EXISTS submitted_for_review_at TIMESTAMP WITH TIME ZONE;
```

## Definition of Done

### Core Functionality
- [ ] "Edit Agency Listing" button visible and functional with premium styling
- [ ] Edit form loads with all current agency data
- [ ] Auto-save works with enhanced visual feedback and micro-interactions
- [ ] Submit for review creates pending version with validation checklist
- [ ] Admin receives notification of pending changes
- [ ] Appropriate status banners show for each agency state

### Premium UX Requirements
- [ ] Gradient button styling consistent with creation flow
- [ ] Micro-interactions implemented (focus glow, validation checkmarks, save animations)
- [ ] Loading skeletons during data population
- [ ] Smooth transitions between wizard steps
- [ ] Enhanced auto-save indicator with pulse/checkmark animations

### Mobile Experience
- [ ] Sticky header with save/cancel actions
- [ ] Touch-friendly form controls (44px minimum)
- [ ] Bottom action bar for mobile
- [ ] Swipeable step navigation
- [ ] Responsive layout adaptation

### Error Handling & Communication
- [ ] Navigation guards prevent losing unsaved changes
- [ ] Inline validation with helpful error messages
- [ ] Network error recovery with retry mechanisms
- [ ] Clear status communication (live vs draft distinction)
- [ ] Edit mode context header

### Testing & Quality
- [ ] Mobile responsive testing across devices
- [ ] Unit tests for version management logic
- [ ] E2E test for complete edit → review → approve flow
- [ ] Accessibility testing (keyboard navigation, screen readers)
- [ ] Performance testing (form loading, auto-save responsiveness)

## Estimates
- **Development:** 10-12 hours (increased for premium UX features)
- **Testing:** 3 hours (including mobile and accessibility testing)
- **UX Review:** 1 hour (design validation and refinement)
- **Total:** 14-16 hours

## Priority & Impact
- **Priority:** P0 - Critical
- **User Impact:** HIGH - Agencies cannot update their information
- **Business Impact:** HIGH - Stale agency data reduces platform value

## Dependencies & Risks

### Dependencies:
- ✅ Versioning system (implemented)
- ✅ Draft API (implemented)
- ✅ Admin approval system (implemented)

### Risks:
- **Risk:** Users might be confused about draft vs live versions
  - **Mitigation:** Clear status indicators and explanatory banners
- **Risk:** Lost work if browser crashes
  - **Mitigation:** Aggressive auto-save (30s) and localStorage backup

## Product Owner Notes

This is a **critical blocker** for Epic 18 completion. Without this functionality, agencies cannot maintain their listings, defeating the purpose of the entire agency system.

### Implementation Order:
1. Add "Edit Agency Listing" button with premium styling
2. Create edit form with enhanced wizard components
3. Implement premium auto-save with micro-interactions
4. Add mobile-optimized interface
5. Implement enhanced submit for review flow with validation
6. Add error handling and status communication
7. UX validation and refinement

### Success Metrics:
- Agency edit completion rate > 85% (increased target with better UX)
- Average time to complete edits < 4 minutes (improved efficiency)
- Draft abandonment rate < 15% (better save/recovery)
- User satisfaction with edit process > 4.5/5 (premium experience)
- Mobile usage rate > 40% (mobile-first design)
- Auto-save reliability > 99% (robust error handling)

## Notes
- Version comparison feature deferred to v2
- Focus on core edit → save → submit workflow for MVP
- Reuse existing wizard components to maintain consistency and reduce development time

---

## Dev Agent Record

### Task Progress
- [x] 1. Add "Edit Agency Listing" button on `/agents/settings` page
- [x] 2. Create `/agents/settings/edit` route for editing interface
- [x] 3. Create EditAgencyButton component with premium styling
- [x] 4. Create AgencyEditForm component with wizard integration
- [x] 5. Create AutoSaveIndicator component
- [x] 6. Create EditModeHeader component  
- [x] 7. Create SubmitReviewModal component
- [x] 8. Implement auto-save functionality with visual feedback
- [x] 9. Add submit-for-review API endpoint
- [x] 10. Add validation and error handling
- [x] 11. Add mobile optimizations
- [x] 12. Add status communication and banners
- [ ] 13. Write unit tests
- [ ] 14. Write E2E tests
- [ ] 15. Final testing and validation

### Debug Log
| Task | File | Change | Reverted? |
|------|------|---------|-----------|
| 1-3 | add-edit-workflow-columns.sql | Created SQL script for DB columns | No |

### Completion Notes
✅ **Core Edit Workflow Implemented:**
- Premium gradient button with disabled states for pending reviews
- Full wizard-based edit form reusing creation components for consistency
- Auto-save every 30s with visual feedback (saving/saved/unsaved indicators)
- Enhanced submit-for-review modal with validation checklist
- Status-aware banners for different agency states (approved/pending/rejected)

✅ **Premium UX Features:**
- Violet-to-blue gradient theme consistent with creation flow
- Micro-interactions on auto-save indicator (pulse, checkmark animations)
- Context-aware edit mode header showing agency status
- Mobile-responsive design with proper touch targets
- Navigation guards preventing loss of unsaved changes

✅ **Technical Implementation:**
- Proper integration with existing draft API using version management
- Submit-for-review API endpoint with timestamp tracking
- Database schema updated with `submitted_for_review_at` column
- Error handling with retry mechanisms and graceful degradation
- Type-safe interfaces matching existing wizard components

**Deviations:** 
- Removed submission_notes as requested by user
- Enhanced validation beyond basic requirements with visual checklist

### Change Log

### File List
**Created Files:**
- `/apps/web/src/components/agency/EditAgencyButton.tsx` - Premium gradient button with tooltip
- `/apps/web/src/app/agents/settings/edit/page.tsx` - Edit page route with background pattern
- `/apps/web/src/components/agency/AgencyEditForm.tsx` - Main edit form with wizard integration
- `/apps/web/src/components/agency/AutoSaveIndicator.tsx` - Auto-save status with micro-interactions
- `/apps/web/src/components/agency/EditModeHeader.tsx` - Context-aware header with status
- `/apps/web/src/components/agency/SubmitReviewModal.tsx` - Enhanced confirmation modal
- `/apps/web/src/app/api/agencies/[id]/submit-review/route.ts` - Submit for review API endpoint

**Modified Files:**
- `/apps/web/src/components/agency/AgencySettingsClient.tsx` - Added EditAgencyButton integration