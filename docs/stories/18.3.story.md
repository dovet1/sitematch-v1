# User Story 18.3: Agency Management Dashboard

## Story Title
Build Agency Management Interface for Profile Editing and Agent Management

## User Story
As an **agency administrator**,  
I want **to manage my agency profile and team members**,  
So that **I can keep our information current and control team access**.

## Story Context

### Existing System Integration:
- Integrates with: User dashboard, existing settings patterns
- Technology: Next.js, Supabase, existing form components
- Follows pattern: Dashboard layouts, settings pages
- Touch points: User profile, listing management interface

## Acceptance Criteria

### Functional Requirements:

1. **Agency Detail Page - Premium Public Profile (`/agents/[id]`)**
   - **Hero Section:**
     - Large agency logo with gradient background overlay
     - Agency name with typography scale (32px desktop, 24px mobile)
     - Coverage areas displayed as elegant location pins with map integration
     - Contact CTA prominently positioned with phone and email icons
   
   - **Information Architecture:**
     - **About Section:** Rich text description with proper line spacing and typography
     - **Specialisms:** Industry tags with icons, color-coded by category
     - **Team Section:** Professional agent grid with hover effects
     - **Listings Section:** Property cards consistent with main site design
     - **Contact Form:** Slide-in modal with professional form design
   
   - **Agent Profile Cards:**
     - 200px × 280px card dimensions with consistent aspect ratios
     - Professional headshots with fallback to initials in brand colors  
     - Contact information revealed on hover (desktop) or tap (mobile)
     - Role badges with subtle styling (admin crown icon, member dot)
   
   - **Responsive Behavior:**
     - Desktop: 3-column agent grid, 4-column listing grid
     - Tablet: 2-column layouts with optimized spacing
     - Mobile: Single column with card-based stacking
   
   - **Admin Controls:**
     - Floating "Edit Agency" button with icon, visible only to admins
     - Conditional display based on user permissions
     - Smooth transition to management interface

2. **Agency Management Dashboard - Professional Control Center (`/agents/[id]/manage`)**
   - **Dashboard Shell & Architecture:**
     - **Header:** Agency logo, name, and approval status with clear visual indicators
     - **Status Banner:** Prominent approval status with color coding and next steps
     - **Layout:** Sidebar navigation (desktop) / bottom tabs (mobile)
     - **Breadcrumbs:** Clear navigation path with agency context
   
   - **Approval Status Indicators:**
     - **Approved:** Green checkmark with "Live" badge
     - **Pending:** Yellow clock icon with "Under Review" and estimated timeline
     - **Rejected:** Red warning with expandable rejection reasons
     - **Draft:** Gray pencil icon with "Unsaved Changes" counter
   
   - **Navigation System:**
     - **Desktop:** Left sidebar with icons and labels
     - **Mobile:** Bottom tab bar with haptic feedback
     - **Active States:** Clear visual indication of current section
     - **Badge Notifications:** Unread counts on relevant tabs
   
   - **Mobile-First Management UX:**
     - **Touch Targets:** All interactive elements minimum 48px
     - **Gestures:** Swipe between tabs, pull-to-refresh for live data
     - **Modal System:** Full-screen mobile modals with proper header/navigation
     - **Bulk Actions:** Long-press selection with multi-select toolbar
     - **FAB:** Floating action button for primary actions (add agent, save changes)
   
   - **Profile Management Tab:**
     - Edit agency name, description, website
     - Update logo (upload/remove, mobile camera/gallery support)
     - Edit coverage areas (free-text field, 500 char limit with counter)
     - Update specialisms (mobile-friendly multi-select)
     - **Two-Stage Update Process:**
       - Minor changes (description, coverage): Save as draft, require approval
       - Major changes (name, logo, specialisms): Immediate draft, require approval
       - Show clear distinction between live data and pending changes
     - View version history of changes with diff comparison
     - If rejected: View admin notes prominently with correction guidance
     - Auto-save drafts every 30 seconds
   
   - **Team Management Tab - Agent Coordination Center:**
     - **Agent Overview:**
       - **Desktop:** Table view with avatar, name, role, status, actions
       - **Mobile:** Card-based layout with expandable details
       - **Status Indicators:** Color-coded badges (active, pending, inactive)
       - **Quick Actions:** Role change, contact, remove with confirm dialogs
     
     - **Add Agent Experience:**
       - **Method Selection:** Toggle between "Direct Add" vs "Send Invitation"
       - **Direct Add Form:** Multi-step inline form with preview
       - **Invitation System:** Simple email input with role selection
       - **Bulk Invite:** CSV upload option for larger teams
     
     - **Agent Management:**
       - **Profile Editing:** Inline editing with auto-save capabilities
       - **Role Management:** Dropdown with role descriptions and permissions
       - **Contact Tools:** Direct email/phone integration with native apps
       - **Status Management:** Toggle active/inactive with reason tracking
     
     - **Mobile Team Management:**
       - **Swipe Actions:** Swipe agent cards for quick edit/remove
       - **Bottom Sheets:** Form inputs slide up from bottom
       - **Confirmation Modals:** Clear warning dialogs for destructive actions
       - **Batch Operations:** Multi-select mode with action bar
   
   - **Settings Tab:**
     - View agency ID and creation date
     - Delete agency (admin only, requires confirmation)
     - Export agency data (CSV format)

3. **User Dashboard Integration**
   - Add "My Agency" section to user dashboard
   - Show agency card with quick stats
   - Link to agency management dashboard
   - Display role in agency
   - Quick link to agency public page

4. **Agent Profile Management**
   - **Immediate Updates (No Approval Required):**
     - Agent can update own phone number
     - Agent can update own coverage area
     - Agent can update own headshot photo
     - Changes reflected immediately on agency page
   
   - **Approval Required Updates:**
     - Adding new agents to agency
     - Changing agent roles
     - Removing agents from agency
     - Changes to agent contact information by admin

5. **Permissions System**
   - Admins: Full edit rights, member management
   - Members: View agency, edit own profile
   - Public: View only
   - Implement proper RLS policies

### Integration Requirements:
6. Use existing form validation patterns
7. Follow current dashboard navigation structure
8. Maintain consistent modal patterns for confirmations
9. Use existing toast notifications for feedback

### Quality Requirements:
10. Changes save without page reload (optimistic updates for immediate changes)
11. Proper loading states during saves with progress indication
12. Clear feedback on successful/failed operations with specific messaging
13. Audit log for significant changes (member removal, role changes)
14. Concurrent edit detection with conflict resolution
15. Mobile-responsive forms and interactions
16. Auto-save functionality with visual indicators
17. Offline capability for viewing data

## Technical Notes

### Implementation Approach:
```typescript
// New pages/components
- /app/agents/[id]/page.tsx - Public agency detail
- /app/agents/[id]/manage/page.tsx - Management dashboard
- /components/agency/AgencyDetail.tsx - Detail view component
- /components/agency/management/*.tsx - Management components

// Modified components
- /app/occupier/dashboard/page.tsx - Add agency section

// API Routes
- /api/agencies/[id]/update - Update agency details
- /api/agencies/[id]/members - Manage members
- /api/agencies/[id]/delete - Delete agency

// Database updates
- Add audit_log table for tracking changes
```

### Key Constraints:
- Implement row-level security for all operations
- Cache agency data to reduce database calls
- Limit file upload size for headshots (2MB)
- Ensure cascade deletes work properly

### Permissions Matrix:
```
Action                  | Admin | Member | Public
------------------------|-------|---------|--------
View agency            | ✓     | ✓       | ✓
Edit agency info       | ✓     | ✗       | ✗
Manage members         | ✓     | ✗       | ✗
Edit own profile       | ✓     | ✓       | ✗
View member details    | ✓     | ✓       | ✓ (limited)
Delete agency          | ✓     | ✗       | ✗
```

## Definition of Done
- [ ] Agency detail page displays all information
- [ ] Management dashboard fully functional
- [ ] All CRUD operations working for agency data
- [ ] Team management features operational
- [ ] Permissions properly enforced
- [ ] User dashboard shows agency section
- [ ] Agent self-service profile editing works
- [ ] Mobile responsive design
- [ ] Proper error handling throughout
- [ ] Unit tests for permission logic
- [ ] E2E tests for management flows

## Estimates
- **Development:** 12-14 hours
- **Testing:** 3 hours
- **Total:** 15-17 hours

## Dependencies
- Stories 18.1 and 18.2 must be completed
- Requires agency data to exist for testing

## Concurrent Edit Handling
- **Detection**: Compare timestamps on save attempts
- **Resolution**: Show conflict modal with side-by-side changes
- **Options**: Accept theirs, keep yours, or manual merge
- **Prevention**: Real-time editing indicators (show who's editing)

## Mobile Table Management
- **Agent List**: Card-based layout on mobile screens
- **Bulk Operations**: Long-press selection with bottom action sheet
- **Filtering**: Drawer-based filters with touch-friendly controls
- **Sorting**: Simple dropdown with common sort options
- **Pagination**: Load more button instead of traditional pagination

## Error Handling & Edge Cases
- **Network Failures**: Queue changes for retry with visual indication
- **File Upload Errors**: Show progress and retry options
- **Permission Changes**: Handle mid-session role changes gracefully
- **Agency Deletion**: Confirm cascade effects and prevent if active listings exist
- **Session Expiry**: Auto-save and prompt for re-authentication
- **Large Teams**: Implement virtual scrolling for 50+ agents

## Dashboard UX Excellence Features
- **Real-time Collaboration:**
  - Live editing indicators showing when other admins are making changes
  - Conflict resolution modals with side-by-side comparison
  - Auto-refresh of data when changes made by other users
  - Optimistic UI updates with rollback on failure

- **Smart Data Management:**
  - Auto-save with visual confirmation (subtle flash or checkmark)
  - Version history with visual diff highlighting
  - Bulk operations with progress indicators
  - Export functionality with format options (PDF, CSV, JSON)

- **Mobile Dashboard Excellence:**
  - Gesture-based navigation with smooth transitions
  - Contextual toolbars that appear when needed
  - Intelligent form inputs (phone number formatting, email validation)
  - Camera integration for photo uploads with cropping tools

- **Status & Feedback Systems:**
  - Toast notifications for all actions with undo capability where applicable
  - Progress bars for async operations (file uploads, saves)
  - Smart error messages with suggested solutions
  - Success animations that provide satisfying feedback

## Accessibility & Inclusion
- **Keyboard Navigation:** Full keyboard accessibility with logical tab order
- **Screen Readers:** Comprehensive ARIA labels and live regions
- **Color Independence:** Information conveyed through multiple visual cues
- **Font Scaling:** Responsive to user's system font size preferences
- **High Contrast:** Support for high contrast mode
- **Focus Management:** Proper focus handling in modals and dynamic content

## Notes
- Consider adding activity feed for agency changes
- Future: Analytics dashboard for agency performance  
- Future: Customizable agency page themes
- Important: Ensure data privacy compliance for agent information
- Mobile-first responsive design required
- Progressive web app features for offline editing
- **Design Language:** Consistent with creation wizard and directory established in previous stories