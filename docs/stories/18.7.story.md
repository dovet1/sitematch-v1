# Story 18.7: Agency Version Control & Approval

## Status: Ready

## Story

As an **admin**,
I want **to review and approve agency profile changes through a version control system**,
So that **quality and accuracy are maintained across all agency profiles**.

## Story Context

**Existing System Integration:**
- Integrates with: Admin panel, existing listing approval workflow, email notifications
- Technology: Next.js 14, React, TypeScript, Supabase, SendGrid/Resend
- Follows pattern: Mirrors existing listing version approval system
- Touch points: Admin dashboard, agency profiles, notification system

## Acceptance Criteria

**Functional Requirements:**

1. **Moderation Queue**:
   - View all pending agency versions in admin panel
   - Sort by: submission date, agency name, version number
   - Filter by: status (pending/approved/rejected)
   - Pagination for large datasets
2. **Version Comparison**:
   - Side-by-side diff view of current vs proposed version
   - Highlight changed fields in different colors
   - Show who submitted and when
   - Version history timeline
3. **Approval Actions**:
   - Approve: Makes version live immediately
   - Reject: Requires feedback message
   - Request Changes: Send back with specific notes
   - Bulk approve for minor changes (admin setting)
4. **Notifications**:
   - Email to submitter on approval/rejection
   - Include rejection reason or change requests
   - Dashboard notification for submitter
   - Slack/webhook integration for admin team
5. **Audit Trail**:
   - Log all approval actions
   - Track: who, what, when, why
   - Exportable audit reports

**Permission Requirements:**

6. Only admin role can access moderation queue
7. Super admin can review other admin's actions
8. Submitter can view their version status
9. Public users see only approved versions

**SLA Tracking:**

10. Track time from submission to review
11. Alert if version pending >24 hours
12. Dashboard metrics for approval times

## Technical Notes

**Implementation Approach:**
- Reuse diff visualization from listing approvals
- Implement WebSocket for real-time queue updates
- Background job for SLA monitoring
- Email templates for notifications

**Component Structure:**
```
/app/admin/agencies/moderation/page.tsx - Queue page
/components/admin/AgencyModerationQueue.tsx - Queue list
/components/admin/AgencyVersionDiff.tsx - Comparison view
/components/admin/AgencyApprovalActions.tsx - Action buttons
/lib/agency-moderation.ts - Business logic
```

**Database Queries:**
```sql
-- Pending versions queue
SELECT 
  av.*,
  a.name as agency_name,
  u.email as submitter_email
FROM agency_versions av
JOIN agencies a ON av.agency_id = a.id
JOIN users u ON av.submitted_by = u.id
WHERE av.status = 'pending'
ORDER BY av.submitted_at ASC;

-- Version comparison
SELECT 
  current.data as current_data,
  proposed.data as proposed_data,
  proposed.version_number
FROM agency_versions current
JOIN agency_versions proposed ON current.agency_id = proposed.agency_id
WHERE current.id = ? AND proposed.id = ?;
```

**Notification Templates:**
```typescript
const approvalEmail = {
  subject: 'Your agency profile has been approved',
  body: `Great news! Your agency profile updates have been approved and are now live.`
};

const rejectionEmail = {
  subject: 'Agency profile changes need revision',
  body: `Your recent changes require revision: ${feedback}`
};
```

## Definition of Ready

- [x] Acceptance criteria defined
- [x] Technical approach documented
- [x] Notification templates drafted
- [ ] Admin UI mockups approved
- [ ] SLA thresholds agreed
- [ ] Story pointed by team

## Definition of Done

- [ ] Moderation queue implemented
- [ ] Version diff visualization working
- [ ] Approval/rejection flow complete
- [ ] Email notifications configured
- [ ] Audit logging implemented
- [ ] SLA tracking functional
- [ ] Bulk operations available
- [ ] Unit tests >80% coverage
- [ ] Integration tests for approval flow
- [ ] Performance testing with 100+ versions
- [ ] Admin documentation written
- [ ] Deployed to staging
- [ ] Admin team trained
- [ ] Product Owner sign-off