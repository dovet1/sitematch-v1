# Story 18.9: Agency RLS (Row Level Security) Policies

## Status: Ready

## Story

As a **platform architect**,
I want **comprehensive RLS policies for all agency-related tables**,
So that **data access is properly controlled and secure across all user roles**.

## Story Context

**Existing System Integration:**
- Integrates with: Supabase RLS system, existing user roles (anon, authenticated, service_role)
- Technology: PostgreSQL RLS, Supabase Auth
- Follows pattern: Similar to existing listing and listing_versions RLS policies
- Touch points: All agency tables, public API access, admin functions

## Acceptance Criteria

**Functional Requirements:**

1. **agencies table policies**:
   - **Public Read (anon)**: Can read approved agencies only
   - **Authenticated Read**: Can read agencies they own
   - **Create**: Authenticated users can create agencies (limit 1 per user)
   - **Update**: Only agency owner can update
   - **Delete**: Soft delete only by owner or platform admin

2. **agency_versions table policies**:
   - **Public Read (anon)**: Can read approved versions only
   - **Authenticated Read**: Can read versions for agencies they own
   - **Create**: Only agency owner can create versions
   - **Update**: No updates allowed (versions are immutable)
   - **Delete**: No deletes allowed (audit trail)

3. **agency_team_members table policies**:
   - **Public Read (anon)**: Can read team members of approved agencies
   - **Authenticated Read**: Can read all team members for owned agencies
   - **Create/Update/Delete**: Only agency owner

4. ~~**agency_agents table**~~ - NOT NEEDED
   - Only agency creator can edit
   - No multi-user collaboration
   - Simplifies permissions significantly

5. **listing-agency relationship**:
   - **Read**: Public can see agency associations on listings
   - **Update**: Only listing owner can link/unlink agency
   - **Constraint**: Can only link to approved agencies (except owner's own)

## Technical Notes

**RLS Policy Definitions:**

```sql
-- Enable RLS on all tables
ALTER TABLE agencies ENABLE ROW LEVEL SECURITY;
ALTER TABLE agency_versions ENABLE ROW LEVEL SECURITY;
ALTER TABLE agency_team_members ENABLE ROW LEVEL SECURITY;

-- AGENCIES TABLE POLICIES
-- Public can view approved agencies
CREATE POLICY "Public can view approved agencies" 
  ON agencies FOR SELECT 
  TO anon 
  USING (status = 'approved');

-- Authenticated users can view their own agencies
CREATE POLICY "Users can view own agencies" 
  ON agencies FOR SELECT 
  TO authenticated 
  USING (created_by = auth.uid());

-- Users can create agencies (limit 1 per user initially)
CREATE POLICY "Authenticated users can create agencies" 
  ON agencies FOR INSERT 
  TO authenticated 
  WITH CHECK (
    created_by = auth.uid() AND
    NOT EXISTS (
      SELECT 1 FROM agencies 
      WHERE created_by = auth.uid()
    )
  );

-- Only agency owner can update
CREATE POLICY "Agency owners can update" 
  ON agencies FOR UPDATE 
  TO authenticated 
  USING (created_by = auth.uid())
  WITH CHECK (created_by = auth.uid());

-- AGENCY_VERSIONS TABLE POLICIES
-- Public can view approved versions
CREATE POLICY "Public can view approved agency versions" 
  ON agency_versions FOR SELECT 
  TO anon 
  USING (status = 'approved');

-- Users can view versions for their agencies
CREATE POLICY "Users can view own agency versions" 
  ON agency_versions FOR SELECT 
  TO authenticated 
  USING (
    agency_id IN (
      SELECT id FROM agencies 
      WHERE created_by = auth.uid()
    )
  );

-- Only agency owner can create versions
CREATE POLICY "Agency owners can create versions" 
  ON agency_versions FOR INSERT 
  TO authenticated 
  WITH CHECK (
    agency_id IN (
      SELECT id FROM agencies 
      WHERE created_by = auth.uid()
    )
  );

-- AGENCY_TEAM_MEMBERS TABLE POLICIES
-- Public can view team members of approved agencies
CREATE POLICY "Public can view team members of approved agencies" 
  ON agency_team_members FOR SELECT 
  TO anon 
  USING (
    agency_id IN (
      SELECT id FROM agencies WHERE status = 'approved'
    )
  );

-- Agency owners can manage team members
CREATE POLICY "Agency owners can manage team members" 
  ON agency_team_members FOR ALL 
  TO authenticated 
  USING (
    agency_id IN (
      SELECT id FROM agencies 
      WHERE created_by = auth.uid()
    )
  );

-- LISTINGS TABLE - Agency linking
-- Anyone can read agency associations
CREATE POLICY "Public can view listing agency associations" 
  ON listings FOR SELECT 
  USING (true); -- Assuming listings already have their own RLS

-- Only listing owner can update agency association
CREATE POLICY "Listing owners can update agency link" 
  ON listings FOR UPDATE 
  TO authenticated 
  USING (created_by = auth.uid())
  WITH CHECK (
    -- Can only link to approved agencies or own agencies
    linked_agency_id IS NULL OR
    linked_agency_id IN (
      SELECT id FROM agencies 
      WHERE status = 'approved' OR created_by = auth.uid()
    )
  );
```

**Admin Override Policies:**

```sql
-- Create admin role function
CREATE OR REPLACE FUNCTION is_admin()
RETURNS boolean AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM user_roles 
    WHERE user_id = auth.uid() AND role = 'admin'
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Admin can view all agencies
CREATE POLICY "Admins can view all agencies" 
  ON agencies FOR SELECT 
  TO authenticated 
  USING (is_admin());

-- Admin can update any agency version status
CREATE POLICY "Admins can moderate agency versions" 
  ON agency_versions FOR UPDATE 
  TO authenticated 
  USING (is_admin())
  WITH CHECK (is_admin());
```

**Service Role Exceptions:**

```sql
-- Service role bypasses RLS (for admin operations, background jobs)
-- This is automatic in Supabase for service_role key
```

**Testing Considerations:**

```sql
-- Test queries to verify policies
-- As anon user (public)
SET ROLE anon;
SELECT * FROM agencies WHERE status = 'approved'; -- Should work
SELECT * FROM agencies WHERE status = 'draft'; -- Should return empty

-- As authenticated user
SET ROLE authenticated;
SET request.jwt.claim.sub = 'user-uuid-here';
SELECT * FROM agencies WHERE created_by = 'user-uuid-here'; -- Should work

-- Reset role
RESET ROLE;
```

## Definition of Ready

- [x] RLS policies defined for all tables
- [x] Admin override patterns established
- [x] Test queries documented
- [ ] Security review completed
- [ ] Performance impact assessed
- [ ] Story pointed by team

## Definition of Done

- [ ] All RLS policies created in migration file
- [ ] Policies tested for each role (anon, authenticated, admin)
- [ ] No data leaks verified through testing
- [ ] Performance benchmarks met
- [ ] Admin functions working correctly
- [ ] Service role operations verified
- [ ] Security audit passed
- [ ] Documentation updated
- [ ] Migration deployed to staging
- [ ] Product Owner sign-off