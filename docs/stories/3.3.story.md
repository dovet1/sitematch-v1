# Story 3.3: Complete Listing Creation Integration & Testing

## Status: Draft

## Story

- As an **authenticated Occupier**
- I want to complete the full listing creation process from wizard to database
- so that I can successfully submit my property requirements for admin approval and go live

## Acceptance Criteria (ACs)

1. **End-to-End Integration**: Complete integration of wizard UI with database API and file storage
2. **Data Submission**: Successfully submit complete listing data including locations and files
3. **Admin Workflow**: Listings created with "pending" status for admin approval
4. **User Feedback**: Clear success/error messaging and post-submission guidance
5. **Data Validation**: Comprehensive validation across all form steps before submission
6. **Error Recovery**: Robust error handling with ability to recover from submission failures
7. **Post-Submission Flow**: Redirect to listing dashboard or success page after creation

## User Prerequisites

Before development begins, the user must complete these setup tasks:

### External Service Configuration
1. **Email Service Setup** (User Action Required):
   - Confirm Resend email service is configured and working (from Story 2.1)
   - Verify email templates exist for listing submission confirmations
   - Provide email sender configuration: `RESEND_FROM_EMAIL` environment variable
   - Test email delivery to avoid submission confirmations going to spam

### Development Prerequisites  
2. **Integration Testing**: All previous stories (3.0, 3.1, 3.2) completed and tested
3. **Admin Workflow**: Admin approval process defined and tested
4. **User Journey**: Post-submission user experience and messaging defined
5. **Error Messaging**: Approve all user-facing error messages and success copy

## Tasks / Subtasks

- [ ] Task 0: API Integration (AC: 1, 2)
  - [ ] Integrate wizard form submission with listings API
  - [ ] Handle file upload and location data in API payload
  - [ ] Implement proper error handling for API calls
  - [ ] Add request/response logging for debugging
  - [ ] Test complete data flow from form to database

- [ ] Task 1: Data Validation & Processing (AC: 5)
  - [ ] Implement comprehensive pre-submission validation
  - [ ] Add cross-field validation rules
  - [ ] Process location data for database insertion
  - [ ] Handle file upload URLs in listing data
  - [ ] Validate all required fields across steps

- [ ] Task 2: Submission Flow (AC: 3, 4)
  - [ ] Implement listing submission with proper status setting
  - [ ] Add loading states during submission process
  - [ ] Create success/error messaging system
  - [ ] Handle partial submission failures gracefully
  - [ ] Add submission progress indicators

- [ ] Task 3: Error Handling & Recovery (AC: 6)
  - [ ] Implement comprehensive error handling
  - [ ] Add retry mechanisms for failed submissions
  - [ ] Handle network connectivity issues
  - [ ] Provide clear error messages to users
  - [ ] Allow users to save draft and continue later

- [ ] Task 4: Post-Submission Experience (AC: 7)
  - [ ] Create listing submission success page
  - [ ] Implement redirect to user dashboard
  - [ ] Add email confirmation for successful submissions
  - [ ] Show submission status and next steps
  - [ ] Provide links to admin contact if needed

- [ ] Task 5: Integration Testing (AC: 1-7)
  - [ ] End-to-end testing of complete listing creation flow
  - [ ] Test all error scenarios and recovery paths
  - [ ] Validate data integrity from form to database
  - [ ] Test file upload integration with listing creation
  - [ ] Performance testing for complete submission flow

- [ ] Task 6: User Acceptance Testing
  - [ ] Test complete user journey with real occupier users
  - [ ] Validate wizard UX and submission flow
  - [ ] Test error handling and recovery from user perspective
  - [ ] Gather feedback on success messaging and next steps
  - [ ] Verify mobile and desktop experience

## Definition of Ready

- [ ] Stories 3.0, 3.1, and 3.2 completed and tested
- [ ] Admin approval workflow tested and working
- [ ] Success/error message content approved
- [ ] Post-submission user journey defined

## Definition of Done

- [ ] Complete listing creation flow working end-to-end
- [ ] All validation and error handling implemented
- [ ] Success and error messaging clear and helpful
- [ ] Integration tests passing for complete flow
- [ ] User acceptance testing completed successfully
- [ ] Performance requirements met
- [ ] Documentation updated

## Dev Technical Guidance

### Integration Flow

```typescript
// Complete submission flow
async function submitListing(formData: WizardFormData): Promise<SubmissionResult> {
  try {
    // 1. Upload brochure if provided
    let brochureUrl = null;
    if (formData.brochureFile) {
      brochureUrl = await uploadBrochure(formData.brochureFile, formData.orgId);
    }
    
    // 2. Prepare listing data
    const listingData = {
      title: formData.title,
      description: formData.description,
      sector: formData.sector,
      use_class: formData.useClass,
      site_size_min: formData.siteSizeMin,
      site_size_max: formData.siteSizeMax,
      brochure_url: brochureUrl,
      company_name: formData.companyName,
      company_description: formData.companyDescription,
      contact_email: formData.contactEmail,
      contact_phone: formData.contactPhone,
      locations: formData.locations,
      status: 'pending'
    };
    
    // 3. Submit to API
    const response = await fetch('/api/listings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(listingData)
    });
    
    if (!response.ok) {
      throw new Error(`Submission failed: ${response.statusText}`);
    }
    
    const result = await response.json();
    return { success: true, listingId: result.id };
    
  } catch (error) {
    console.error('Listing submission failed:', error);
    return { success: false, error: error.message };
  }
}
```

### Error Handling Strategy

```typescript
interface SubmissionError {
  type: 'validation' | 'network' | 'server' | 'upload';
  message: string;
  field?: string;
  retryable: boolean;
}

function handleSubmissionError(error: SubmissionError): void {
  switch (error.type) {
    case 'validation':
      // Show field-specific error
      setFieldError(error.field, error.message);
      break;
    case 'network':
      // Show retry option
      showRetryDialog(error.message);
      break;
    case 'upload':
      // Handle file upload specific errors
      showFileUploadError(error.message);
      break;
    case 'server':
      // Show general server error
      showServerError(error.message);
      break;
  }
}
```

### Post-Submission States

```typescript
interface SubmissionState {
  status: 'idle' | 'submitting' | 'success' | 'error';
  progress: number; // 0-100
  error?: SubmissionError;
  listingId?: string;
}

// Success page data
interface SubmissionSuccess {
  listingId: string;
  title: string;
  submittedAt: Date;
  estimatedReviewTime: string;
  nextSteps: string[];
}
```

### API Enhancement

```typescript
// Enhanced listings API endpoint
export async function POST(request: Request) {
  try {
    const data = await request.json();
    
    // Validate complete listing data
    const validation = validateListingData(data);
    if (!validation.valid) {
      return Response.json(
        { error: 'Validation failed', details: validation.errors },
        { status: 400 }
      );
    }
    
    // Create listing in transaction
    const result = await createListingWithLocations(data);
    
    // Send confirmation email
    await sendSubmissionConfirmation(data.contact_email, result.id);
    
    return Response.json({
      success: true,
      id: result.id,
      message: 'Listing submitted successfully for review'
    });
    
  } catch (error) {
    console.error('Listing creation failed:', error);
    return Response.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

### File Locations

- **Integration Logic**: `/apps/web/src/lib/listing-submission.ts`
- **Success Page**: `/apps/web/src/app/occupier/listing-submitted/[id]/page.tsx`
- **Error Components**: `/apps/web/src/components/listings/submission-error.tsx`
- **Email Templates**: `/apps/web/src/lib/email-templates/`
- **Enhanced API**: `/apps/web/src/app/api/listings/route.ts`

## Testing Requirements

- [ ] Jest Integration Tests: complete submission flow
- [ ] E2E Tests: full user journey from start to finish
- [ ] Error Scenario Tests: all failure modes and recovery
- [ ] Performance Tests: submission under load
- [ ] User Acceptance Tests: real user validation

## Dependencies

**Required Completed Stories**:
- **Story 3.0** (Database Schema) - for data persistence
- **Story 3.1** (Wizard UI) - for form components
- **Story 3.2** (Location & Upload) - for location search and file upload

**External Dependencies**:
- Email service for confirmation emails
- Admin notification system for new submissions

## Estimated Effort

**Story Points**: 5
**Sprint Capacity**: 1 sprint (5-8 days)

## Success Metrics

- **Submission Success Rate**: >95% of valid submissions complete successfully
- **Error Recovery Rate**: >90% of users can recover from submission errors
- **User Satisfaction**: >4.5/5 rating on submission experience
- **Performance**: <5 seconds for complete submission process

## Risk Assessment

**Medium Risk Areas**:
- Complex error handling across multiple systems
- File upload integration with form submission
- User experience during error states

**Mitigation Strategies**:
- Comprehensive error testing and user feedback
- Progressive enhancement for file uploads
- Clear error messaging and recovery paths

## Dev Agent Record

[To be filled during implementation]

## QA Results

[To be filled during implementation]