# Story 3.3: Complete Listing Creation Integration & Testing

## Status: Draft

## Story

- As an **authenticated Occupier**
- I want to complete the full listing creation process from enhanced wizard to database including FAQ management
- so that I can successfully submit comprehensive property requirements with detailed information for admin approval and go live

## Acceptance Criteria (ACs)

1. **Enhanced End-to-End Integration**: Complete integration of enhanced wizard UI with database API, multi-type file storage, and FAQ system
2. **Comprehensive Data Submission**: Successfully submit complete listing data including enhanced contact fields, multiple file types, locations, and FAQs
3. **FAQ Management System**: Implement accordion-based FAQ creation and management within the wizard
4. **Enhanced Admin Workflow**: Listings created with "pending" status including all new PRD-required fields
5. **Advanced User Feedback**: Clear success/error messaging with enhanced post-submission guidance and confirmation emails
6. **Comprehensive Data Validation**: Complete validation across all enhanced form steps including new required fields
7. **Robust Error Recovery**: Advanced error handling with ability to recover from complex submission failures
8. **Enhanced Post-Submission Flow**: Rich success page with listing summary and clear next steps

## User Prerequisites

Before development begins, the user must complete these setup tasks:

### External Service Configuration
1. **Email Service Setup** (User Action Required):
   - Confirm Resend email service is configured and working (from Story 2.1)
   - Verify email templates exist for listing submission confirmations
   - Provide email sender configuration: `RESEND_FROM_EMAIL` environment variable
   - Test email delivery to avoid submission confirmations going to spam

### Development Prerequisites  
2. **Integration Testing**: All previous stories (3.0, 3.1, 3.2) completed and tested
3. **Admin Workflow**: Admin approval process defined and tested
4. **User Journey**: Post-submission user experience and messaging defined
5. **Error Messaging**: Approve all user-facing error messages and success copy

## Tasks / Subtasks

- [ ] Task 0: Enhanced API Integration (AC: 1, 2)
  - [ ] Integrate enhanced wizard form submission with updated listings API
  - [ ] Handle multi-type file uploads and location data in API payload
  - [ ] Implement FAQ data processing and storage
  - [ ] Add comprehensive error handling for all new data types
  - [ ] Add detailed request/response logging for debugging complex submissions
  - [ ] Test complete enhanced data flow from form to database

- [ ] Task 1: FAQ Management System (AC: 3)
  - [ ] Create FAQ accordion component for dynamic question/answer pairs
  - [ ] Implement add/remove FAQ functionality with validation
  - [ ] Add rich text support for FAQ answers
  - [ ] Integrate FAQ management into wizard flow
  - [ ] Add FAQ data validation and processing
  - [ ] Test FAQ creation, editing, and removal

- [ ] Task 2: Enhanced Data Validation & Processing (AC: 6)
  - [ ] Implement comprehensive pre-submission validation for all PRD fields
  - [ ] Add validation for enhanced contact fields (name, title)
  - [ ] Add multi-file validation and processing
  - [ ] Process enhanced location data with nationwide toggle
  - [ ] Handle complex file upload URLs and metadata
  - [ ] Validate all required fields across enhanced wizard steps

- [ ] Task 3: Enhanced Submission Flow (AC: 4, 5)
  - [ ] Implement enhanced listing submission with all PRD fields
  - [ ] Add progressive loading states for complex submissions
  - [ ] Create enhanced success/error messaging system
  - [ ] Handle partial submission failures for multi-file uploads
  - [ ] Add detailed submission progress indicators for complex operations

- [ ] Task 4: Advanced Error Handling & Recovery (AC: 7)
  - [ ] Implement comprehensive error handling for all submission types
  - [ ] Add intelligent retry mechanisms for failed file uploads and API calls
  - [ ] Handle network connectivity issues with offline detection
  - [ ] Provide contextual error messages for different failure scenarios
  - [ ] Allow users to save draft with all enhanced data and continue later
  - [ ] Implement submission recovery from browser crashes or interruptions

- [ ] Task 5: Enhanced Post-Submission Experience (AC: 8)
  - [ ] Create rich listing submission success page with summary
  - [ ] Implement enhanced redirect to user dashboard with success state
  - [ ] Add comprehensive email confirmation with listing details
  - [ ] Show detailed submission status and clear next steps
  - [ ] Provide admin contact information and support resources
  - [ ] Add estimated review timeline and process explanation

- [ ] Task 6: Comprehensive Integration Testing (AC: 1-8)
  - [ ] End-to-end testing of complete enhanced listing creation flow
  - [ ] Test all error scenarios and recovery paths for complex submissions
  - [ ] Validate data integrity for all enhanced fields and file types
  - [ ] Test FAQ system integration with listing creation
  - [ ] Performance testing for complex submissions with multiple files
  - [ ] Test enhanced validation across all wizard steps

- [ ] Task 7: Enhanced User Acceptance Testing
  - [ ] Test complete enhanced user journey with real occupier users
  - [ ] Validate enhanced wizard UX including FAQ management
  - [ ] Test error handling and recovery from user perspective
  - [ ] Gather feedback on enhanced success messaging and next steps
  - [ ] Verify mobile and desktop experience for all new features
  - [ ] Test accessibility compliance for all enhanced components

## Definition of Ready

- [ ] Stories 3.0, 3.1, and 3.2 completed and tested
- [ ] Admin approval workflow tested and working
- [ ] Success/error message content approved
- [ ] Post-submission user journey defined

## Definition of Done

- [ ] Complete listing creation flow working end-to-end
- [ ] All validation and error handling implemented
- [ ] Success and error messaging clear and helpful
- [ ] Integration tests passing for complete flow
- [ ] User acceptance testing completed successfully
- [ ] Performance requirements met
- [ ] Documentation updated

## Dev Technical Guidance

### Integration Flow

```typescript
// Enhanced complete submission flow with all PRD requirements
async function submitEnhancedListing(formData: EnhancedWizardFormData): Promise<SubmissionResult> {
  try {
    // 1. Upload all file types with progress tracking
    const fileUploads = await uploadAllFiles(formData, (progress) => {
      updateSubmissionProgress(progress * 0.4); // Files are 40% of submission
    });
    
    // 2. Process FAQ data
    const processedFaqs = formData.faqs.map((faq, index) => ({
      question: faq.question,
      answer: faq.answer,
      display_order: index
    }));
    
    // 3. Prepare enhanced listing data with all PRD fields
    const enhancedListingData = {
      // Basic listing info
      title: formData.title,
      description: formData.description,
      sector_id: formData.sectorId,
      use_class_id: formData.useClassId,
      site_size_min: formData.siteSizeMin,
      site_size_max: formData.siteSizeMax,
      
      // Enhanced contact fields (PRD required)
      contact_name: formData.contactName,
      contact_title: formData.contactTitle,
      contact_email: formData.contactEmail,
      contact_phone: formData.contactPhone,
      
      // Company information
      company_name: formData.companyName,
      company_description: formData.companyDescription,
      
      // File URLs
      logo_url: fileUploads.logoUrl,
      brochure_url: fileUploads.brochureUrl,
      
      // Location data with nationwide toggle
      locations: formData.isNationwide ? [] : formData.locations,
      is_nationwide: formData.isNationwide,
      
      // FAQ data
      faqs: processedFaqs,
      
      // Additional files
      site_plan_urls: fileUploads.sitePlanUrls,
      fit_out_urls: fileUploads.fitOutUrls,
      
      status: 'pending'
    };
    
    updateSubmissionProgress(60); // Data preparation complete
    
    // 4. Submit to enhanced API
    const response = await fetch('/api/listings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(enhancedListingData)
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || `Submission failed: ${response.statusText}`);
    }
    
    updateSubmissionProgress(90); // API call complete
    
    const result = await response.json();
    
    // 5. Send confirmation email
    await sendSubmissionConfirmation(formData.contactEmail, result.id);
    
    updateSubmissionProgress(100); // Complete
    
    return { 
      success: true, 
      listingId: result.id,
      message: 'Listing submitted successfully for admin review'
    };
    
  } catch (error) {
    console.error('Enhanced listing submission failed:', error);
    return { 
      success: false, 
      error: error.message,
      type: categorizeError(error)
    };
  }
}

async function uploadAllFiles(formData: EnhancedWizardFormData, onProgress: (progress: number) => void): Promise<FileUploadResults> {
  const results: FileUploadResults = {};
  let completedUploads = 0;
  const totalFiles = countTotalFiles(formData);
  
  // Upload logo
  if (formData.logoFile) {
    results.logoUrl = await uploadFile(formData.logoFile, 'logo', formData.orgId);
    completedUploads++;
    onProgress(completedUploads / totalFiles);
  }
  
  // Upload brochure
  if (formData.brochureFile) {
    results.brochureUrl = await uploadFile(formData.brochureFile, 'brochure', formData.orgId);
    completedUploads++;
    onProgress(completedUploads / totalFiles);
  }
  
  // Upload site plans
  if (formData.sitePlanFiles.length > 0) {
    results.sitePlanUrls = await Promise.all(
      formData.sitePlanFiles.map(async (file) => {
        const url = await uploadFile(file, 'sitePlan', formData.orgId);
        completedUploads++;
        onProgress(completedUploads / totalFiles);
        return url;
      })
    );
  }
  
  // Upload fit-out examples
  if (formData.fitOutFiles.length > 0) {
    results.fitOutUrls = await Promise.all(
      formData.fitOutFiles.map(async (file) => {
        const url = await uploadFile(file, 'fitOut', formData.orgId);
        completedUploads++;
        onProgress(completedUploads / totalFiles);
        return url;
      })
    );
  }
  
  return results;
}
```

### Error Handling Strategy

```typescript
interface SubmissionError {
  type: 'validation' | 'network' | 'server' | 'upload';
  message: string;
  field?: string;
  retryable: boolean;
}

function handleSubmissionError(error: SubmissionError): void {
  switch (error.type) {
    case 'validation':
      // Show field-specific error
      setFieldError(error.field, error.message);
      break;
    case 'network':
      // Show retry option
      showRetryDialog(error.message);
      break;
    case 'upload':
      // Handle file upload specific errors
      showFileUploadError(error.message);
      break;
    case 'server':
      // Show general server error
      showServerError(error.message);
      break;
  }
}
```

### Post-Submission States

```typescript
interface SubmissionState {
  status: 'idle' | 'submitting' | 'success' | 'error';
  progress: number; // 0-100
  error?: SubmissionError;
  listingId?: string;
}

// Success page data
interface SubmissionSuccess {
  listingId: string;
  title: string;
  submittedAt: Date;
  estimatedReviewTime: string;
  nextSteps: string[];
}
```

### API Enhancement

```typescript
// Enhanced listings API endpoint
export async function POST(request: Request) {
  try {
    const data = await request.json();
    
    // Validate complete listing data
    const validation = validateListingData(data);
    if (!validation.valid) {
      return Response.json(
        { error: 'Validation failed', details: validation.errors },
        { status: 400 }
      );
    }
    
    // Create listing in transaction
    const result = await createListingWithLocations(data);
    
    // Send confirmation email
    await sendSubmissionConfirmation(data.contact_email, result.id);
    
    return Response.json({
      success: true,
      id: result.id,
      message: 'Listing submitted successfully for review'
    });
    
  } catch (error) {
    console.error('Listing creation failed:', error);
    return Response.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

### Enhanced File Locations

- **Enhanced Integration Logic**: `/apps/web/src/lib/enhanced-listing-submission.ts`
- **FAQ Management Component**: `/apps/web/src/components/listings/faq-manager.tsx`
- **Enhanced Success Page**: `/apps/web/src/app/occupier/listing-submitted/[id]/page.tsx`
- **Enhanced Error Components**: 
  - `/apps/web/src/components/listings/submission-error.tsx`
  - `/apps/web/src/components/listings/file-upload-error.tsx`
- **Enhanced Email Templates**: `/apps/web/src/lib/email-templates/`
- **Progress Components**: `/apps/web/src/components/listings/submission-progress.tsx`
- **Enhanced API**: `/apps/web/src/app/api/listings/route.ts`
- **FAQ API**: `/apps/web/src/app/api/listings/[id]/faqs/route.ts`

## Testing Requirements

- [ ] Jest Integration Tests: complete submission flow
- [ ] E2E Tests: full user journey from start to finish
- [ ] Error Scenario Tests: all failure modes and recovery
- [ ] Performance Tests: submission under load
- [ ] User Acceptance Tests: real user validation

## Dependencies

**Required Completed Stories**:
- **Story 3.0** (Database Schema) - for data persistence
- **Story 3.1** (Wizard UI) - for form components
- **Story 3.2** (Location & Upload) - for location search and file upload

**External Dependencies**:
- Email service for confirmation emails
- Admin notification system for new submissions

## Estimated Effort

**Story Points**: 8
**Sprint Capacity**: 1-2 sprints (8-12 days)

## Success Metrics

- **Submission Success Rate**: >95% of valid submissions complete successfully
- **Error Recovery Rate**: >90% of users can recover from submission errors
- **User Satisfaction**: >4.5/5 rating on submission experience
- **Performance**: <5 seconds for complete submission process

## Risk Assessment

**Medium Risk Areas**:
- Complex error handling across multiple systems
- File upload integration with form submission
- User experience during error states

**Mitigation Strategies**:
- Comprehensive error testing and user feedback
- Progressive enhancement for file uploads
- Clear error messaging and recovery paths

## Dev Agent Record

[To be filled during implementation]

## QA Results

[To be filled during implementation]