# User Story 18.4: Listing-Agency Integration

## Story Title
Connect Listings to Agencies with Shared Visibility and Management

## User Story
As an **agency member**,  
I want **my listings to be associated with my agency**,  
So that **they appear on our agency profile and can be managed by my team**.

## Story Context

### Existing System Integration:
- Integrates with: Existing listing system, create/edit flows
- Technology: Supabase, existing listing components
- Follows pattern: Current listing ownership model
- Touch points: Listing creation, listing management, listing display

## Acceptance Criteria

### Functional Requirements:

1. **Listing Creation Integration - Seamless Agency Association**
   - **Agency Section Design:**
     - **Visual Integration:** Subtle card section within existing flow, not intrusive
     - **Conditional Display:** Only appears for agency members, completely hidden otherwise
     - **Progressive Disclosure:** Section expands smoothly when agency membership detected
   
   - **Single Agency Experience:**
     - **Smart Default:** Pre-selected checkbox with agency logo and name
     - **Visual Confirmation:** Agency branding visible in a compact, elegant way
     - **Opt-out Option:** Clear "List as individual" checkbox for personal listings
     - **Tooltip Guidance:** Helpful explanation of agency association benefits
   
   - **Multiple Agency Experience:**
     - **Elegant Selector:** Dropdown with agency logos, names, and member counts
     - **Search Capability:** Real-time filtering for users with many agencies  
     - **None Option:** "Don't associate with agency" as first option
     - **Visual Preview:** Selected agency appears in listing preview
   
   - **Mobile Optimization:**
     - **Bottom Sheet:** Agency selection opens in bottom sheet modal
     - **Touch-Friendly:** Large touch targets with agency logos
     - **Search Integration:** Search input with keyboard shortcuts
     - **Quick Selection:** Recently used agencies appear first

2. **Listing Edit Updates**
   - Add agency association option in edit form
   - Allow adding/removing agency association
   - Only listing owner can change agency association
   - Log agency association changes

3. **Agency Profile Integration**
   - Display all agency-associated listings on agency page
   - Group by property type or status
   - Show listing cards with key details
   - Link to full listing details
   - Display count of active listings

4. **Shared Visibility Rules & Permission Hierarchy**
   - **SiteMatcher Admins (Highest Priority):**
     - Override any agency or listing decision
     - Approve/reject all listing changes regardless of source
     - Can remove agency associations
   
   - **Agency Admins:**
     - View all agency-associated listings
     - Edit any agency listing (triggers listing re-approval workflow)
     - Remove agency association from any listing
     - Changes by agency admin create new listing version requiring SM admin approval
   
   - **Agency Members:**
     - View all agency-associated listings
     - Edit only their own listings (standard approval workflow)
     - Cannot remove others' agency associations
     - Cannot edit others' listing content
   
   - **Listing Owners (Original Creators):**
     - Always retain edit rights to their own listings
     - Can remove their own listings from agency
     - Can transfer agency association between their agencies
   
   - **Non-members:**
     - View approved public agency listings only
     - No edit capabilities

5. **Listing Management Dashboard - Enhanced Agency Experience**
   - **Filter Integration:**
     - **Agency Filter:** Elegant toggle switch "Show agency listings only"
     - **Visual Separation:** Agency listings have subtle border accent
     - **Quick Stats:** "X of Y listings associated with agencies"
     - **Bulk Agency Actions:** Multi-select with agency association options
   
   - **Listing Card Enhancements:**
     - **Agency Badge:** Small, tasteful logo badge in corner of listing cards
     - **Hover Details:** Agency name and role appear on hover
     - **Status Indicators:** Shared listing permissions shown with icons
     - **Quick Actions:** Agency-specific actions in card dropdown
   
   - **Mobile Dashboard:**
     - **Swipe Gestures:** Swipe listing cards for quick agency actions
     - **Filter Drawer:** Side panel with agency filtering options
     - **Batch Mode:** Long-press to enter multi-select with agency tools
     - **Card Density:** Optimized layout showing agency information efficiently

6. **Migration & Backwards Compatibility**
   - Existing listings remain unchanged and fully functional
   - Optional migration wizard for bulk agency association
   - Non-agency users completely unaffected
   - Listing APIs remain backward compatible
   - Agency deletion: Associated listings remain with original owners
   - User leaving agency: Their listings automatically dissociated
   - Agency rejection: Listing associations preserved but not publicly visible

### Integration Requirements:
7. Preserve existing listing ownership model
8. Maintain current RLS policies with additions
9. Keep existing listing cards with agency badge
10. Use current permission checking patterns

### Quality Requirements:
11. No performance degradation on listing queries
12. Clear indication of agency association
13. Audit trail for agency-listing changes
14. Consistent permission enforcement

## Technical Notes

### Implementation Approach:
```typescript
// Modified components
- /components/listings/CreateListingForm.tsx - Add agency selection
- /components/listings/EditListingForm.tsx - Agency association
- /components/listings/ListingCard.tsx - Show agency badge
- /app/occupier/dashboard/page.tsx - Agency filter

// New components
- /components/agency/AgencyListings.tsx - Listings section
- /components/listings/AgencySelector.tsx - Association UI

// Database changes
- Update RLS policies for shared visibility
- Add indexes for agency_listings queries
- Create view for agency listing counts

// API updates
- /api/listings/create - Handle agency association
- /api/listings/[id]/update - Update association
- /api/agencies/[id]/listings - Fetch agency listings
```

### Key Constraints:
- User remains primary owner of listing at all times
- Agency association is always optional
- Deleting agency removes associations but preserves all listings
- User leaving agency automatically removes their listing associations
- Agency admin edits trigger new listing approval cycle
- Mobile: Agency selection UI optimized for touch interaction
- Concurrent edit detection when multiple users modify same listing
- Audit trail for all agency-listing association changes

### Data Model:
```sql
-- Already created in Story 18.1
-- agency_listings junction table
-- Just needs RLS policies:

CREATE POLICY "Agency members can view agency listings"
  ON agency_listings FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM agency_agents
      WHERE agency_agents.agency_id = agency_listings.agency_id
      AND agency_agents.user_id = auth.uid()
    )
  );

CREATE POLICY "Listing owners can manage associations"
  ON agency_listings FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM listings
      WHERE listings.id = agency_listings.listing_id
      AND listings.user_id = auth.uid()
    )
  );
```

### Permission Logic:
```typescript
canEditListing(listing, user, agency) {
  // Owner always can edit
  if (listing.user_id === user.id) return true;
  
  // Agency admin can edit if associated
  if (agency && listing.agency_id === agency.id) {
    return userIsAgencyAdmin(user, agency);
  }
  
  return false;
}
```

## Definition of Done
- [ ] Listing creation includes agency association
- [ ] Listing edit allows association changes
- [ ] Agency profile shows all associated listings
- [ ] Shared visibility working per requirements
- [ ] Dashboard filtering by agency works
- [ ] Permissions properly enforced
- [ ] No regression in existing listing features
- [ ] Performance metrics unchanged
- [ ] Migration tool available (if needed)
- [ ] Unit tests for permission logic
- [ ] E2E tests for integration flows

## Estimates
- **Development:** 10-12 hours
- **Testing:** 3 hours
- **Total:** 13-15 hours

## Dependencies
- Stories 18.1, 18.2, and 18.3 must be completed
- Requires test listings and agencies

## Cascading Effects & Safeguards
- **Agency Deletion**: Prevent deletion if agency has active public listings
- **Agency Rejection**: Listing associations hidden from public but preserved
- **User Role Changes**: Mid-session permission updates handled gracefully
- **Listing Approval Conflicts**: Clear hierarchy (SM Admin > Agency Admin > Owner)
- **Concurrent Edits**: Show editing indicators and conflict resolution

## Mobile Experience
- **Agency Selection**: Modal picker with search and favorites
- **Bulk Operations**: Long-press selection with confirmation sheets
- **Permission Indicators**: Clear visual cues for edit capabilities
- **Network Handling**: Offline mode for viewing, queue changes for sync

## Data Integrity Rules
- Listing ownership cannot be transferred via agency association
- Agency association changes require explicit user consent
- Audit log captures all association modifications with timestamps
- Cascade deletion only after confirming no active dependencies
- Version control ensures no data loss during approval cycles

## Seamless Integration UX Features
- **Visual Consistency:**
  - Agency branding elements consistent across all touchpoints
  - Subtle visual hierarchy that doesn't overwhelm non-agency content
  - Smooth transitions when agency features appear/disappear
  - Consistent iconography and color coding throughout

- **Smart Defaults & Automation:**
  - Remember user's last agency association preference
  - Auto-suggest agency association based on listing type and location
  - Smart bulk operations that respect mixed agency/individual listings
  - Contextual help that appears when users need it

- **Permission Clarity:**
  - Clear visual indicators of who can edit what
  - Permission tooltips that explain collaboration capabilities  
  - Visual differentiation between personal and agency actions
  - Graceful handling when permissions change mid-session

- **Mobile Excellence:**
  - Agency features don't compromise mobile listing experience
  - Touch-optimized agency selection interfaces
  - Gesture-based quick actions for agency management
  - Responsive agency branding that works on small screens

## Integration Micro-Interactions
- **Association Feedback:** Smooth animation when agency is associated/removed
- **Badge Appearance:** Elegant fade-in of agency badges on listing cards
- **Filter Transitions:** Smooth filtering animations when toggling agency view
- **Permission Changes:** Visual feedback when user permissions update
- **Bulk Operations:** Clear progress indication for multi-listing operations

## Notes
- Consider future: Transfer listing ownership within agency
- Consider future: Agency-level listing templates  
- Important: Maintain data integrity during agency deletion
- Track metrics on agency listing performance vs individual
- Mobile-first responsive design for all agency interactions
- Progressive enhancement for advanced permission features
- **Integration Quality:** Agency features should feel like natural extensions, not bolted-on additions