# Story 5.0: Admin Moderation System

## Status: Draft

## Story

- As an **Admin user**
- I want to review, approve, reject, and moderate occupier listing submissions
- so that I can ensure only quality, legitimate property requirements are published in the public directory

## Acceptance Criteria (ACs)

1. **Admin Dashboard**: Protected admin dashboard with listing moderation queue
2. **Listing Review Interface**: Comprehensive view of submitted listings with all details
3. **Moderation Actions**: Approve, reject (with reason), and archive listings
4. **Approval Workflow**: Clear workflow from submitted → approved → published
5. **Rejection Feedback**: Provide rejection reasons to occupiers via email
6. **Admin Authentication**: Secure admin-only access with proper role verification
7. **Audit Trail**: Log all moderation actions with timestamps and admin details
8. **Bulk Actions**: Handle multiple listings efficiently with bulk operations

## User Prerequisites

Before development begins, the user must:
1. **Moderation Policy**: Define approval criteria and rejection reasons
2. **Admin Access**: Confirm admin user creation and access management
3. **Communication**: Approve rejection email templates and feedback process

## Tasks / Subtasks

- [ ] Task 1: Admin Dashboard Setup (AC: 1, 6)
  - [ ] Create protected admin route `/admin/dashboard`
  - [ ] Implement admin role verification middleware
  - [ ] Add admin navigation layout with moderation sections
  - [ ] Create dashboard overview with moderation statistics
  - [ ] Apply "Violet Bloom" design system to admin interface

- [ ] Task 2: Moderation Queue Interface (AC: 2, 4)
  - [ ] Create listing moderation queue table view
  - [ ] Display key listing information: company, size, submission date, status
  - [ ] Add status indicators: pending, approved, rejected, archived
  - [ ] Implement sorting and filtering by status, date, company
  - [ ] Add quick action buttons for each listing

- [ ] Task 3: Listing Review Modal (AC: 2, 3)
  - [ ] Create detailed listing review modal/page
  - [ ] Display all submission information: company details, requirements, files
  - [ ] Show contact information and supporting documents
  - [ ] Add moderation action buttons: approve, reject, archive
  - [ ] Include rejection reason input with predefined options

- [ ] Task 4: Moderation Actions Implementation (AC: 3, 5, 7)
  - [ ] Implement approve action: change status to approved
  - [ ] Create reject workflow with mandatory reason selection
  - [ ] Add archive functionality for outdated/invalid listings
  - [ ] Send rejection email notifications to occupiers
  - [ ] Log all moderation actions with admin ID and timestamp

- [ ] Task 5: Bulk Operations (AC: 8)
  - [ ] Add checkbox selection for multiple listings
  - [ ] Implement bulk approve for trusted submissions
  - [ ] Create bulk archive for expired listings
  - [ ] Add bulk reject with common reason selection
  - [ ] Include confirmation dialogs for bulk operations

- [ ] Task 6: Admin API & Database (AC: 7)
  - [ ] Create admin-only API endpoints for moderation
  - [ ] Add moderation_log table for audit trail
  - [ ] Implement listing status state management
  - [ ] Create email notification system for rejections
  - [ ] Add admin activity logging and monitoring

## Definition of Ready

- [ ] Admin moderation policy defined
- [ ] Rejection reason categories approved
- [ ] Admin access management confirmed
- [ ] Email notification templates ready

## Definition of Done

- [ ] Admin dashboard accessible to admin users only
- [ ] Moderation queue displays all submitted listings
- [ ] Approve/reject/archive actions working correctly
- [ ] Rejection emails sent to occupiers automatically
- [ ] Audit trail logging all moderation activities
- [ ] Bulk operations implemented and tested
- [ ] Admin interface responsive and accessible

## Dev Technical Guidance

### Database Schema

```sql
-- Add status and moderation fields to listings table
ALTER TABLE listings 
ADD COLUMN status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected', 'archived')),
ADD COLUMN moderated_by UUID REFERENCES users(id),
ADD COLUMN moderated_at TIMESTAMP WITH TIME ZONE,
ADD COLUMN rejection_reason TEXT,
ADD COLUMN published BOOLEAN DEFAULT false;

-- Create moderation log table
CREATE TABLE moderation_log (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  listing_id UUID NOT NULL REFERENCES listings(id),
  admin_id UUID NOT NULL REFERENCES users(id),
  action TEXT NOT NULL CHECK (action IN ('approved', 'rejected', 'archived', 'unarchived')),
  reason TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### API Endpoints

```typescript
// Admin moderation endpoints
GET /api/admin/listings               // Moderation queue
POST /api/admin/listings/[id]/approve // Approve listing
POST /api/admin/listings/[id]/reject  // Reject with reason
POST /api/admin/listings/[id]/archive // Archive listing
POST /api/admin/listings/bulk-action  // Bulk operations
GET /api/admin/moderation-log         // Audit trail
```

### Component Structure

```
/admin/
├── dashboard/page.tsx           // Main admin dashboard
├── listings/
│   ├── page.tsx                // Moderation queue
│   ├── [id]/page.tsx          // Individual listing review
│   └── components/
│       ├── ModerationQueue.tsx // Queue table component
│       ├── ListingReview.tsx   // Review modal/page
│       ├── ModerationActions.tsx // Action buttons
│       └── BulkActions.tsx     // Bulk operation controls
└── components/
    ├── AdminLayout.tsx         // Admin navigation layout
    ├── AdminStats.tsx          // Dashboard statistics
    └── ModerationLog.tsx       // Audit trail display
```

### Email Templates

```typescript
// Rejection email template
const rejectionEmailTemplate = {
  subject: "SiteMatch Listing Review - Action Required",
  template: `
    Dear {{contactName}},
    
    Thank you for submitting your property requirement listing for {{companyName}}.
    
    After review, we need some adjustments before we can publish your listing:
    
    Reason: {{rejectionReason}}
    
    Please log in to your account and update your listing:
    {{listingEditUrl}}
    
    Best regards,
    SiteMatch Team
  `
};
```

### Rejection Reason Categories

```typescript
const rejectionReasons = [
  "Incomplete company information",
  "Missing required contact details", 
  "Unclear property requirements",
  "Invalid or poor quality brochure",
  "Duplicate listing detected",
  "Requirements too vague or broad",
  "Suspected spam or invalid submission",
  "Other (specify below)"
];
```

## Testing Requirements

- [ ] Admin role access verification
- [ ] Moderation actions (approve/reject/archive)
- [ ] Rejection email sending
- [ ] Bulk operations functionality
- [ ] Audit trail logging accuracy
- [ ] Admin dashboard responsiveness
- [ ] Error handling for edge cases

## Dependencies

**Required Completed Stories**:
- **Story 2.0** (Authentication & Roles)
- **Story 3.0** (Database Schema)
- **Story 4.0** (Public Directory)

## Estimated Effort

**Story Points**: 8
**Sprint Capacity**: 1 sprint (5-8 days)

## Success Metrics

- **Moderation Efficiency**: Average review time < 5 minutes per listing
- **Email Delivery**: 99%+ rejection notification delivery rate
- **Admin Productivity**: Bulk operations reduce time by 80%
- **Audit Compliance**: 100% moderation actions logged