# Epic: Agent Directory Feature - Brownfield Enhancement

## Epic Goal
Enable real estate agencies to showcase themselves and their agents on a dedicated directory page, providing visibility to potential clients and integrating with the existing listing system.

## Epic Description

### Existing System Context:
- **Current relevant functionality:** User authentication, listing management, user profiles
- **Technology stack:** Next.js 14, TypeScript, Supabase, Tailwind CSS
- **Integration points:** Auth system, user profiles, listings database, file storage

### Enhancement Details:
- **What's being added:** New agent directory with agency profiles, agent management, and listing integration
- **How it integrates:** Extends existing user system, connects to current listings, uses existing auth flow
- **Success criteria:** Agencies can create profiles, manage agents, and showcase their listings

## Stories

### Story 1: Agent Directory Foundation (18.1)
Create the basic agent directory page with agency display and database schema setup.

### Story 2: Agency Creation Flow (18.2)
Implement the "Add Agency" wizard with profile creation and agent invitation system.

### Story 3: Agency Management Dashboard (18.3)
Build the agency management interface for editing details and managing agents with versioning system.

### Story 4: Listing-Agency Integration (18.4)
Connect existing listings to agencies and enable shared visibility/management.

### Story 5: Admin Agency Approval System (18.5)
Build admin dashboard for reviewing and approving agency submissions and changes.

## Compatibility Requirements
- [x] Existing APIs remain unchanged (new endpoints added only)
- [x] Database schema changes are additive only
- [x] UI changes follow existing design patterns
- [x] Performance impact is minimal (lazy loading for directory)

## Risk Mitigation
- **Primary Risk:** Data relationships between users, agencies, and listings becoming complex
- **Mitigation:** Clear ownership model, agency_listings junction table, maintain user-listing relationship
- **Rollback Plan:** Feature flag in environment variables, tables can be dropped without affecting core functionality

## Definition of Done
- [ ] All 5 stories completed with acceptance criteria met
- [ ] Admin approval workflow functional and tested
- [ ] Agency versioning system working correctly
- [ ] Existing user and listing functionality verified through testing
- [ ] Agency-listing integration working correctly
- [ ] Navigation updated and functioning
- [ ] Mobile responsive implementation
- [ ] Documentation updated appropriately
- [ ] No regression in existing features

## Technical Decisions
1. **Data Model:** Agencies as separate entities with many-to-many relationship to users
2. **Approval System:** Similar to listing_versions with draft/pending/approved/rejected workflow
3. **Permissions:** Role-based (admin/member) at agency level, with SiteMatcher admin oversight
4. **Agent Addition:** Both direct entry and invitation-based options
5. **UI Pattern:** Follow existing card-based layouts and wizard patterns
6. **Storage:** Use existing Supabase storage buckets for logos/headshots
7. **Versioning:** Track all changes through agency_versions table

## Open Questions for Product Owner
1. Can users belong to multiple agencies? (Assumed: Yes, with role per agency)
2. Agency deletion policy? (Suggested: Soft delete, preserve listings)
3. Listing ownership when user leaves agency? (Suggested: Listing stays with original creator)
4. Admin review SLA? (How quickly should agencies be reviewed?)
5. What happens to manually-added agents if they later register? (Auto-link accounts?)
6. Should there be limits on agency size or listing count?