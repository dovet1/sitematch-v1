# User Story 18.5: Admin Agency Approval System

## Story Title
Build Admin Dashboard for Agency Review and Approval

## User Story
As a **SiteMatcher administrator**,  
I want **to review and approve agency submissions and changes**,  
So that **only legitimate agencies with quality information are displayed publicly**.

## Story Context

### Existing System Integration:
- Integrates with: Existing admin dashboard, notification system
- Technology: Next.js admin routes, Supabase RLS policies
- Follows pattern: Current admin approval workflows (listings)
- Touch points: Admin dashboard, email notifications, audit logging

## Acceptance Criteria

### Functional Requirements:

1. **Admin Agency Dashboard - Professional Control Center (`/admin/agencies`)**
   - **Dashboard Header & Overview:**
     - **Statistics Cards:** Visual KPI cards with icons and trend indicators
       - Total agencies (with growth percentage)
       - Pending reviews (with urgency color coding)
       - Approval rate (with monthly comparison)
       - Average review time (with SLA status)
     - **Quick Actions Toolbar:** Prominent buttons for common tasks
     - **Filter Controls:** Clean, pill-style filters with active state indicators
   
   - **Pending Reviews Queue - Priority Interface:**
     - **Priority Visual System:**
       - High priority: Red accent border with urgent badge
       - Medium priority: Yellow accent with standard badge  
       - Low priority: Gray accent with routine badge
     - **Card Design:** 
       - Agency logo, name, and creator prominently displayed
       - Submission timestamp with relative time ("2 days ago")
       - Associated listings count with icon
       - Quick preview expandable with smooth animation
     - **Batch Operations:**
       - Checkbox selection with visual feedback
       - Bulk action bar appears at bottom when items selected
       - Progress indicators for bulk operations
   
   - **Mobile Admin Experience:**
     - **Swipe Actions:** Left swipe for approve (green), right swipe for reject (red)
     - **Card Stack:** Vertical card layout optimized for scrolling
     - **Quick Actions:** Floating action buttons for common tasks
     - **Filter Drawer:** Side panel with touch-friendly controls
   
   - **All Agencies Management Table:**
     - **Advanced Filtering:** Multi-criteria filters with saved filter sets
     - **Smart Search:** Search across agency name, creator, and agent names
     - **Column Customization:** Show/hide columns based on admin preference
     - **Export Options:** CSV, PDF reports with customizable data sets

2. **Agency Review Interface - Comprehensive Evaluation (`/admin/agencies/[id]/review`)**
   - **Split-Screen Layout:**
     - **Left Panel:** Agency preview exactly as it will appear publicly
     - **Right Panel:** Admin review tools and decision interface
     - **Mobile:** Tabbed interface with swipe navigation
   
   - **Agency Preview - Public View Simulation:**
     - **Live Preview:** Real-time rendering of public agency page
     - **Responsive Toggle:** Preview desktop/tablet/mobile views
     - **Interactive Elements:** Test contact forms and agent interactions
     - **Quality Indicators:** Automated quality scores (logo quality, text completeness)
   
   - **Review Decision Interface:**
     - **Action Buttons:** Large, color-coded action buttons with icons
       - Approve: Green with checkmark icon
       - Reject: Red with X icon  
       - Request Changes: Yellow with pencil icon
     - **Rejection Reasons:** Smart dropdown with common rejection categories
       - Incomplete information
       - Poor quality logo/images
       - Inappropriate content
       - Duplicate agency
       - Custom reason with text field
     - **Admin Notes:** Rich text editor for internal documentation
     - **Approval Checklist:** Interactive checklist of review criteria
   
   - **Version Control & History:**
     - **Timeline View:** Visual timeline of all submissions and decisions
     - **Diff Comparison:** Side-by-side comparison with highlighted changes
     - **Previous Reviews:** Access to all previous admin decisions and notes
     - **Resubmission Tracking:** Clear indication of what changed between versions

3. **Approval Workflow:**
   - **On Approval:**
     - Agency status changes to 'approved'
     - Becomes visible on public directory
     - All associated agents receive welcome email
     - Creator receives approval email with next steps
     - Agency listings become visible under agency profile
     - Audit log entry created with admin ID and timestamp
   
   - **On Rejection:**
     - Agency status changes to 'rejected' (not pending)
     - Associated listing visibility remains unchanged (listings stay with owners)
     - Pending agent invitations automatically cancelled
     - Creator receives rejection email with specific reasons and correction guidance
     - Agency creator can edit and resubmit (creates new version)
     - Rejected agencies not visible to public but editable by creator
   
   - **Email Notifications:**
     - Admin receives email for new submissions
     - Creator receives approval/rejection emails
     - Templates match existing listing approval emails

4. **Admin Permissions:**
   - Only users with admin role can access
   - All actions logged with admin ID and timestamp
   - Approval decisions cannot be reversed without trace

5. **Integration with Existing Admin Tools:**
   - Add "Agencies" section to admin navigation
   - Badge showing pending count next to menu item
   - Dashboard widget showing agency statistics

### Integration Requirements:
6. Use existing admin layout and components
7. Follow current RLS policy patterns for admin access
8. Integrate with existing notification system
9. Use same audit logging as listing approvals

### Quality Requirements:
10. Review interface loads in under 2 seconds
11. Bulk operations handle up to 50 agencies with atomic transactions
12. Clear visual distinction between approved/pending/rejected with color coding
13. Mobile-friendly admin interface with touch-optimized controls
14. Offline capability for viewing pending reviews
15. Real-time updates when other admins approve/reject agencies
16. Email delivery tracking with retry mechanism for failed notifications
17. Comprehensive audit trail for all admin actions

## Technical Notes

### Implementation Approach:
```typescript
// New admin pages
- /app/admin/agencies/page.tsx - Main dashboard
- /app/admin/agencies/[id]/review/page.tsx - Review interface
- /components/admin/AgencyReviewCard.tsx - Preview component
- /components/admin/AgencyApprovalActions.tsx - Action buttons

// API routes
- /api/admin/agencies/approve - Approve agency
- /api/admin/agencies/reject - Reject with reason
- /api/admin/agencies/stats - Dashboard statistics

// Database functions
- approve_agency(agency_id, admin_id, notes)
- reject_agency(agency_id, admin_id, reason)
- get_agency_version_history(agency_id)
```

### Key Constraints:
- Only admin users can access these routes with proper RLS enforcement
- All approval actions must be logged with full audit trail
- Email notifications must be reliable with delivery tracking
- Bulk operations must be atomic (all succeed or all fail) with rollback capability
- Mobile admin interface must support all desktop functionality
- Real-time sync between multiple admin sessions
- Handle agencies with associated active listings during rejection
- Prevent approval of agencies with invalid or incomplete data

### RLS Policies for Admin Access:
```sql
CREATE POLICY "Admins can manage all agencies" ON agencies
  FOR ALL TO authenticated
  USING (EXISTS (
    SELECT 1 FROM users 
    WHERE users.id = auth.uid() 
    AND users.role = 'admin'
  ));

CREATE POLICY "Admins can view all agency versions" ON agency_versions
  FOR SELECT TO authenticated
  USING (EXISTS (
    SELECT 1 FROM users 
    WHERE users.id = auth.uid() 
    AND users.role = 'admin'
  ));
```

## Definition of Done
- [ ] Admin agencies dashboard fully functional
- [ ] Agency review interface working with all actions
- [ ] Approval/rejection workflow complete
- [ ] Email notifications sending correctly
- [ ] Audit logging implemented
- [ ] Integration with existing admin navigation
- [ ] Bulk operations working
- [ ] Mobile responsive design
- [ ] Unit tests for approval logic
- [ ] E2E tests for admin workflow

## Estimates
- **Development:** 8-10 hours
- **Testing:** 3 hours
- **Total:** 11-13 hours

## Dependencies
- Stories 18.1, 18.2, and 18.3 must be completed
- Existing admin authentication system
- Email notification service

## Bulk Operation Safeguards
- **Atomic Transactions**: All operations in batch succeed or all rollback
- **Partial Failure Handling**: Clear reporting of which operations failed and why
- **Conflict Resolution**: Handle cases where agencies are modified during bulk operations
- **Performance**: Process operations in chunks to prevent timeout
- **Confirmation**: Always require explicit confirmation for bulk rejection

## Mobile Admin Experience  
- **Dashboard**: Touch-friendly cards with key metrics prominently displayed
- **Review Interface**: Full-screen modal with swipe navigation between agencies
- **Bulk Actions**: Long-press selection with bottom action sheet
- **File Viewing**: Optimized image/document viewing on mobile screens
- **Offline Mode**: Cache pending reviews for offline viewing

## Email & Notification Handling
- **Delivery Tracking**: Monitor email delivery status and provide retry options
- **Template Management**: Consistent branding with existing notification templates
- **Batching**: Group related notifications to prevent email flooding
- **Preferences**: Respect admin notification preferences and frequency
- **Fallback**: In-app notifications when email delivery fails

## Error Scenarios & Recovery
- **Network Failures**: Queue actions with visual feedback and retry mechanisms
- **Session Expiry**: Auto-save review state and prompt for re-authentication
- **Concurrent Modifications**: Detect conflicts and provide merge options
- **Database Errors**: Graceful error handling with actionable error messages
- **File Access Errors**: Fallback methods for viewing agency assets

## Admin Experience Excellence
- **Efficiency Optimization:**
  - Keyboard shortcuts for all common actions (A for approve, R for reject, etc.)
  - Auto-advance to next pending review after decision
  - Smart batch operations with conflict detection and resolution
  - Customizable admin workflow preferences

- **Quality Assurance Tools:**
  - Automated quality scoring with visual indicators
  - Duplicate detection with fuzzy matching algorithms  
  - Image quality analysis for logos and agent photos
  - Text analysis for inappropriate content

- **Mobile Admin Capabilities:**
  - Full-featured mobile admin interface, not just viewing
  - Touch-optimized review interface with swipe gestures
  - Offline review capability with sync when online
  - Push notifications for urgent reviews requiring attention

- **Analytics & Reporting:**
  - Admin performance metrics (review time, approval rates)
  - Agency quality trends over time
  - User feedback integration on approved agencies
  - Automated reporting for management dashboards

## Advanced Admin Features
- **Review Templates:** Save common rejection reasons and approval notes
- **Delegation System:** Assign reviews to specific admin team members
- **Escalation Workflows:** Auto-escalate complex cases to senior admins
- **Audit Trails:** Complete logging of all admin actions with timestamps
- **Bulk Import:** Support for migrating existing agencies with admin oversight

## Professional Polish
- **Loading States:** Elegant skeleton screens during data loading
- **Error Handling:** Graceful error messages with recovery options
- **Success Feedback:** Satisfying completion animations and confirmations
- **Context Preservation:** Remember filter states and preferences across sessions
- **Help Integration:** Contextual help tooltips and documentation links

## Notes
- Consider adding approval SLA tracking (time to review)
- Future: Automated quality checks before admin review
- Future: Agency performance analytics for admins
- Important: Ensure sensitive agent data is properly protected
- Mobile-first admin interface design required
- Progressive web app features for offline admin work
- **Admin UX Consistency:** Interface should match existing admin tools while providing enhanced agency-specific functionality