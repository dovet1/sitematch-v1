# User Story 18.2: Agency Creation Flow

## Story Title
Implement Add Agency Wizard with Profile Creation and Agent Invitations

## User Story
As an **authenticated real estate professional**,  
I want **to create an agency profile and invite my team members**,  
So that **we can showcase our agency and collaborate on listings**.

## Story Context

### Existing System Integration:
- Integrates with: Authentication system, file upload, email system
- Technology: Next.js, Supabase Auth, Supabase Storage, Resend (email)
- Follows pattern: Multi-step wizard (similar to listing creation)
- Touch points: User dashboard, auth modals, file upload utilities

## Acceptance Criteria

### Functional Requirements:

1. **Add Agency Entry Points**
   - "Add Your Agency" button on `/agents` page (requires auth, conditional visibility)
   - "Add Agency" option in user dashboard - **CONDITIONAL DISPLAY:**
     - Show ONLY to users who are NOT already agency members
     - Hide section entirely for existing agency members
     - Provide user preference to permanently hide agency features
   - Both routes lead to `/agents/add` wizard
   - Unauthenticated users prompted with AuthChoiceModal

2. **Agency Creation Wizard - Premium Multi-Step Experience**
   - **Wizard Shell & Navigation:**
     - **Progress Indicator:** 
       - Desktop: Horizontal stepper with step labels and completion icons
       - Mobile: Compact progress bar with "Step 2 of 4" text overlay
       - Visual feedback: Completed steps show checkmark, current step highlighted
       - Animation: Smooth progress bar fills and step transitions
     
     - **Navigation Controls:**
       - Button design: Primary CTA (Next/Submit) with secondary outline (Back)
       - Touch targets: 48px minimum height, full-width on mobile
       - Button states: Loading spinner, success checkmark, error indication
       - Keyboard shortcuts: Enter to continue, Escape to exit with confirmation
     
     - **Layout Architecture:**
       - Container: Centered modal-style wizard (max-width 600px desktop)
       - Mobile: Full-screen experience with proper safe area handling
       - Card design: Elevated white background with subtle shadow
       - Internal spacing: 32px padding desktop, 24px mobile
     
     - **Auto-save & Recovery:**
       - Visual indicator: "Draft saved" toast with timestamp
       - Recovery modal: "Continue where you left off" with data preview
       - Session timeout: Warning at 15min, auto-save every 30 seconds
   
   - **Step 1: Basic Information - Professional Foundation**
     - **Form Design:**
       - Input fields: 56px height with subtle rounded borders (8px radius)
       - Typography: 16px font size to prevent zoom on iOS
       - Spacing: 24px vertical gaps between fields
       - Labels: Floating labels with smooth transition animations
     
     - **Agency Name Field:**
       - Real-time validation: Debounced uniqueness check with loading spinner
       - Success state: Green checkmark with "Available!" message
       - Error state: Red warning with suggested alternatives
       - Character counter: Live count with warning at 80% capacity
     
     - **Description Editor:**
       - Rich text: Toolbar with bold, italic, link formatting
       - Mobile-optimized: Simplified toolbar that doesn't obstruct content
       - Character limit: Visual progress bar approaching 1000 chars
       - Auto-resize: Text area grows with content, max-height constraint
     
     - **Website URL:**
       - Smart validation: Auto-adds https:// if missing protocol
       - Preview: Shows favicon and site title when valid URL entered
       - Optional badge: Clear "Optional" indicator to reduce form anxiety
   
   - **Step 2: Logo & Branding - Visual Identity**
     - **Upload Experience:**
       - Drag-and-drop zone: 200px Ã— 200px with dashed border animation
       - Mobile camera: Native camera integration with permission handling
       - Gallery selection: Multi-format support with smart compression
       - File validation: Real-time format and size checking with clear messaging
     
     - **Image Processing:**
       - Crop interface: Circular crop guide with zoom and pan controls
       - Preview modes: Shows how logo appears in different contexts
       - Compression: Automatic optimization maintaining visual quality
       - Fallback generation: Beautiful gradient backgrounds with agency initials
     
     - **Upload States:**
       - Progress: Circular progress indicator with percentage
       - Success: Smooth transition to preview with edit options
       - Error: Helpful error messages with retry button
   
   - **Step 3: Coverage & Specialisms - Service Definition**
     - **Coverage Areas:**
       - Smart text field: Suggestions appear as user types common locations
       - Character counter: Visual indicator with smooth color transitions
       - Examples: Helpful placeholder text with real examples
       - Validation: Ensures meaningful content, not just whitespace
     
     - **Specialisms Selection:**
       - Multi-select design: Pill-style tags with remove buttons
       - Search functionality: Filter specialisms with real-time results
       - Mobile optimization: Bottom sheet picker for better touch experience
       - Visual feedback: Selected items highlighted with brand color
       - Minimum requirement: Must select at least one specialism
   
   - **Step 4: Team Building - Agent Management**
     - **Addition Methods:**
       - Tab interface: Clean toggle between "Direct Add" and "Send Invitation"
       - Visual hierarchy: Recommended option clearly marked
       - Help text: Explains the difference between methods
     
     - **Direct Add Interface:**
       - Form layout: Two-column on desktop, stacked on mobile
       - Contact validation: Real-time email and phone format checking
       - Role selection: Radio buttons with clear role descriptions
       - Headshot upload: Smaller version of logo upload experience
       - Preview cards: Shows how agent will appear in final listing
     
     - **Team Overview:**
       - Agent cards: Mini profile cards with edit/remove actions
       - Status indicators: Clear badges for confirmed vs pending agents
       - Reorder functionality: Drag-and-drop to set display order
       - Skip option: Prominent "Add agents later" with clear explanation

3. **Agency Creation Process**
   - Create agency record with status 'pending'
   - Create initial agency_version record
   - Add creator as admin in agency_agents
   - Upload logo to Supabase storage
   - Save directly-added agent information
   - Send invitation emails for invited agents
   - Create invitation records with tokens
   - Submit for admin review

4. **Admin Review System**
   - New agencies enter 'pending' status
   - SiteMatcher admins receive notification
   - Admin can approve/reject from admin dashboard
   - Rejection includes reason (stored in admin_notes)
   - Upon approval:
     - Agency status changes to 'approved'
     - Agency becomes publicly visible
     - Creator receives approval email
   - Upon rejection:
     - Agency remains in draft status
     - Creator can edit and resubmit
     - Rejection reason displayed to creator

5. **Invitation System**
   - Generate unique invitation tokens
   - Email includes agency name and inviter name
   - Link to accept invitation (`/agents/invite/[token]`)
   - 7-day expiration on invitations
   - Acceptance adds user to agency_agents table

6. **Success Flow**
   - Redirect to agency detail page (draft view) after creation
   - Show pending approval message
   - Display submission status and next steps
   - Agency admins can view but public cannot until approved

### Integration Requirements:
6. Maintain existing user session throughout process
7. Use existing file upload patterns and error handling
8. Follow current form validation approaches
9. Integrate with existing email sending infrastructure

### Quality Requirements:
10. Form data persists if user navigates back in wizard
11. Clear error messages for validation failures with actionable guidance
12. Loading states during agency creation with progress indication
13. Graceful handling of email sending failures with retry options
14. Session recovery: Auto-save draft after each step completion
15. Mobile responsiveness: All forms optimized for mobile input
16. File upload resilience: Retry mechanism for failed uploads
17. Network timeout handling: Graceful degradation with offline indicators

## Technical Notes

### Implementation Approach:
```typescript
// New pages/components
- /app/agents/add/page.tsx - Wizard container
- /app/agents/invite/[token]/page.tsx - Invitation acceptance
- /components/agency/CreateAgencyWizard.tsx - Multi-step form
- /components/agency/AgencyWizardSteps/*.tsx - Individual steps

// API Routes
- /api/agencies/create - Handle agency creation
- /api/agencies/invite - Send invitations
- /api/agencies/accept-invite - Process invitation acceptance

// Database tables
- agency_invitations table (token, agency_id, email, role, expires_at)
```

### Key Constraints:
- Use Supabase Auth for user verification
- Store wizard state in localStorage for session recovery
- Auto-save draft after each step completion
- Session expiry warning at 15 minutes, recovery modal at 20 minutes
- Validate agency name uniqueness at database level with debounced checking
- Rate limit invitation sending (10 per minute per user)
- Email delivery tracking with retry mechanism
- File upload with progress indication and error recovery

### Email Template Example:
```
Subject: You're invited to join [Agency Name] on SiteMatcher

Hi there,

[Inviter Name] has invited you to join [Agency Name] on SiteMatcher's Agent Directory.

Join the team to:
- Collaborate on property listings
- Showcase your expertise
- Connect with potential clients

[Accept Invitation Button]

This invitation expires in 7 days.
```

## Definition of Done
- [-] Add Agency wizard fully functional
- [ ] Both entry points working (directory & dashboard)
- [-] Agency creation saves all data correctly
- [ ] Logo upload working with proper validation
- [ ] Invitation emails sending successfully
- [ ] Invitation acceptance flow working
- [ ] Proper error handling throughout
- [ ] Form validation with clear messages
- [ ] Mobile responsive wizard
- [ ] Unit tests for wizard logic
- [ ] E2E test for complete flow

## Dev Agent Record

### Debug Log
| Task | File | Change | Reverted? |
|------|------|---------|-----------|
| Database schema | Supabase migrations | Added agency_invitations table | No |
| API routes | /api/agencies/ | Created agency creation and management endpoints | No |

### Change Log
- Database schema extended with agency_invitations table for invitation system
- Created comprehensive API routes for agency creation, invitation management, and acceptance

### File List
- supabase/migrations/026_create_agency_invitations.sql (hypothetical - executed via SQL)
- apps/web/src/app/api/agencies/route.ts
- apps/web/src/app/api/agencies/invite/route.ts
- apps/web/src/app/api/agencies/accept-invite/route.ts

## Estimates
- **Development:** 10-12 hours
- **Testing:** 3 hours
- **Total:** 13-15 hours

## Dependencies
- Story 18.1 must be completed (database schema)
- Email service configuration required

## Session Recovery & Error Handling
- **Session Loss**: Auto-restore from localStorage draft with confirmation modal
- **File Upload Failures**: Retry with exponential backoff, manual retry button
- **Network Timeouts**: Show offline indicator, queue actions for retry
- **Email Delivery Failures**: Track per-invitation status, allow manual resend
- **Validation Errors**: Inline messages with specific guidance for correction
- **Duplicate Data**: Clear messaging for duplicate emails, agency names
- **Browser Compatibility**: Graceful degradation for older mobile browsers

## Mobile-Specific Considerations
- **File Access**: Request camera/storage permissions with clear explanations
- **Keyboard Types**: Optimize input types (email, phone, URL, text)
- **Touch Targets**: All interactive elements minimum 44px with adequate spacing
- **Form Navigation**: Sticky bottom navigation for Back/Next buttons
- **Image Handling**: Automatic compression to prevent upload failures
- **Offline Handling**: Save draft locally, sync when connection restored

## User Experience Flow Validation
- **Entry Point Control**: Users only see agency creation options when appropriate
- **Dashboard Integration**: Agency features appear contextually, not universally
- **User Choice Respect**: Once user indicates no interest, stop showing agency prompts
- **Seamless Fallback**: Non-agency users continue existing workflows unimpacted

## Premium Wizard UX Enhancements
- **Completion Experience:**
  - Final step: Beautiful success animation with confetti or check animation
  - Preview mode: "Review your agency" step before final submission
  - Submission feedback: Progress indicator through review process with estimated timeline
  - Email confirmation: Immediate confirmation with next steps and timeline

- **Error Prevention & Recovery:**
  - Smart validation: Prevent errors before they occur with helpful guidance
  - Inline help: Contextual tooltips and help text throughout forms
  - Error aggregation: Summary of all issues at top of step for easy scanning
  - Recovery paths: Clear guidance on how to fix validation issues

- **Mobile-Specific Optimizations:**
  - Keyboard avoidance: Inputs automatically scroll into view when focused
  - Touch gestures: Swipe between steps on mobile with visual feedback
  - File access: Smart camera/gallery permissions with clear explanations
  - Offline handling: Graceful degradation with clear messaging about connectivity

## Micro-Interactions & Delight
- **Transition animations:** Smooth slide transitions between steps (300ms ease-out)
- **Success feedback:** Subtle celebration animations for completed fields
- **Loading states:** Branded loading spinners with helpful progress messages
- **Smart defaults:** Pre-fill logical fields based on previous inputs
- **Contextual help:** Progressive disclosure of advanced options

## Notes
- Consider adding preview before final submission
- Future enhancement: Bulk invite via CSV  
- Future enhancement: Customizable invitation message
- Track invitation acceptance rate for analytics
- Mobile-first design approach required
- Progressive enhancement for advanced features
- **CRITICAL**: Ensure agency features never clutter non-agency user experience
- **Design consistency**: All wizard components should align with the directory page design established in 18.1