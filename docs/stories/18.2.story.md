# Story 18.2: Agency Registration & Profile Creation

## Status: Ready

## Story

As an **agency representative**,
I want **to quickly create my agency and then enhance the profile**,
So that **I can establish our presence immediately and improve it over time**.

## Story Context

**New System Integration:**
- Integrates with: User authentication system, agencies table, agency detail view
- Technology: Next.js 14, React, TypeScript, Supabase
- Follows pattern: Similar to listing creation flow (create first, enhance later)
- Touch points: User dashboard, agency management interface, versioning system

## Acceptance Criteria

**Functional Requirements:**

1. **Step 1 - Quick Agency Creation**:
   - Simple form with only required fields:
     - Agency Name (required, 2-100 chars)
     - Contact Email (required, validated format)
     - Contact Phone (required, validated format)
   - "Create Agency" button
   - Duplicate name checking before creation
   
2. **Step 2 - Agency Created**:
   - Agency record created in `agencies` table with status "draft"
   - User sees success message
   - Two options presented:
     - "Enhance Profile" - Opens editable agency view
     - "Submit for Review" - Submits minimal profile as-is

3. **Step 3 - Profile Enhancement** (if chosen):
   - Navigate to agency management view (similar to public profile but editable)
   - Inline editing capabilities for:
     - Company description (500 char limit)
     - Logo upload
     - Classification (Commercial/Residential/Both)
     - Geographic patch
     - Team members (add/edit/remove)
     - Website URL
   - Auto-save functionality
   - "Submit for Review" button always visible

4. **Step 4 - Submit for Review**:
   - Creates entry in `agency_versions` table
   - All current agency data stored in JSONB `data` column
   - Version status set to "pending"
   - Email confirmation to user
   - Admin notification triggered

5. **Edit Mode Interface**:
   - Based on public agency detail view layout
   - Inline edit buttons on each section
   - Add/Edit/Delete controls for team members
   - Real-time preview of changes
   - Clear visual indicators of draft status

**Validation Requirements:**

6. Initial creation: name, email, phone required
7. Logo file validation: type (image/*), size (<5MB)
8. Email and website URL format validation
9. Character limits enforced on all text fields
10. Phone number format validation

**Integration Requirements:**

11. Agency created immediately in draft status
12. Version only created on "Submit for Review"
13. All edits saved to agency record until submission
14. Images stored in CDN with proper cache headers

## Technical Notes

**Implementation Approach:**
- Step 1: Simple modal/page with 3 required fields
- Step 2: Redirect to `/agencies/[id]/edit` after creation
- Edit view mirrors public profile with inline editing
- Use contentEditable or inline forms for each section
- Optimistic updates with background saves

**Database Schema:**
```sql
CREATE TABLE agencies (
  id UUID PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  contact_email VARCHAR(255) NOT NULL,
  contact_phone VARCHAR(50) NOT NULL,
  description TEXT,
  classification VARCHAR(20),
  geographic_patch VARCHAR(255),
  website VARCHAR(255),
  logo_url VARCHAR(500),
  office_street_address VARCHAR(255),
  office_city VARCHAR(100),
  office_postcode VARCHAR(20),
  office_country VARCHAR(100),
  office_coordinates POINT,
  status VARCHAR(20) DEFAULT 'draft',
  current_version_id UUID,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);

CREATE TABLE agency_versions (
  id UUID PRIMARY KEY,
  agency_id UUID REFERENCES agencies(id),
  version_number INTEGER,
  data JSONB, -- Contains full agency state at submission
  status VARCHAR(20),
  submitted_at TIMESTAMP,
  reviewed_at TIMESTAMP,
  reviewed_by UUID
);
```

**User Flow:**
```
1. Click "Add Agency" → Modal with 3 fields
2. Submit → Agency created (draft) → Redirect to edit view
3. Edit view: Public profile layout with edit controls
4. Make changes → Auto-save to agency record
5. Click "Submit for Review" → Create version → Status pending
```

## Definition of Ready

- [x] Acceptance criteria defined
- [x] Technical approach documented
- [x] Database schema designed
- [ ] UI/UX mockups approved
- [ ] Image processing strategy confirmed
- [ ] Story pointed by team

## Definition of Done

- [ ] Multi-step form implemented
- [ ] Image upload and processing working
- [ ] Draft save/load functionality complete
- [ ] Email notifications configured
- [ ] Validation and error handling complete
- [ ] Unit tests >80% coverage
- [ ] Integration tests for submission flow
- [ ] Cross-browser testing complete
- [ ] Documentation updated
- [ ] Deployed to staging
- [ ] Product Owner sign-off