# User Story 18.1: Agent Directory Foundation

## Story Title
Create Agent Directory Page with Basic Agency Display

## User Story
As a **site visitor**,  
I want **to browse a directory of real estate agencies**,  
So that **I can discover agencies that serve my area and view their specializations**.

## Story Context

### Existing System Integration:
- Integrates with: Next.js routing system, existing component library
- Technology: Next.js 14 App Router, TypeScript, Supabase, Tailwind CSS
- Follows pattern: Card-based layouts (similar to listing cards)
- Touch points: Navigation header, existing UI components

## Acceptance Criteria

### Functional Requirements:
1. **Database Schema Creation**
   - Create `agencies` table with fields: id, name, logo_url, coverage_areas, specialisms, status, admin_notes, created_by, created_at, updated_at, approved_at, approved_by
   - Create `agency_versions` table for tracking all changes: id, agency_id, version_number, data, status, admin_notes, created_at, created_by, reviewed_at, reviewed_by
   - Create `agency_agents` junction table: agency_id, user_id, email, name, phone, coverage_area, headshot_url, role, is_registered, invitation_token, invitation_expires_at, joined_at
   - Create `agency_listings` junction table: agency_id, listing_id
   - Set up RLS policies for public read (approved only), authenticated write, admin full access

2. **Agent Directory Page - Premium Layout & UX**
   - **Page Header:**
     - Hero section: Gradient background with subtle texture overlay
     - Page title: "Real Estate Agencies" with descriptive subtitle
     - Search prominence: Large, centered search input with premium styling
     - Search UX: Real-time filtering with debounced input, clear button, keyboard shortcuts
   
   - **Grid Layout System:**
     - Desktop (≥1024px): 3-column grid with 32px gaps
     - Tablet (768px-1023px): 2-column grid with 24px gaps  
     - Mobile (<768px): Single column with 16px vertical spacing
     - Container: Max-width 1200px, centered with responsive padding
   
   - **Search & Filtering Experience:**
     - Search bar: 56px height, rounded-full design with search icon
     - Placeholder text: "Search agencies by name, location, or specialty..."
     - Real-time results: Instant filtering with smooth animations
     - No results state: Illustrated empty state with helpful suggestions
     - Search highlighting: Matched text highlighted in results
   
   - **CTA Card Design (Contextual):**
     - Visual prominence: Dashed border card with subtle background pattern
     - Icon: Large "+" icon with gradient background
     - Copy: "Showcase Your Agency" with compelling subtitle
     - Dismissal: Clean "Not interested" link with permanent preference storage
     - Animation: Gentle pulsing effect to draw attention without being intrusive
   
   - **Pagination & Loading:**
     - Pagination: Clean numbered pagination with prev/next arrows
     - Load more: Alternative infinite scroll option for mobile
     - Loading states: Skeleton cards maintaining layout integrity
     - Page size: 12 agencies optimized for various screen sizes
   
   - **Admin Features:**
     - Pending badge: Subtle notification badge with animation
     - Quick access: Floating admin panel button for quick actions

3. **Navigation Integration**
   - Add "Agents" link in header next to "SiteSketcher"
   - Maintain existing navigation patterns and styling
   - Ensure mobile menu includes new link

4. **Agency Card Component - Premium Design Specifications**
   - **Card Architecture:**
     - Elevation: Subtle shadow (0 2px 8px rgba(0,0,0,0.12)) with hover lift (0 4px 16px rgba(0,0,0,0.16))
     - Rounded corners: 12px border-radius for modern feel
     - Background: Pure white (#FFFFFF) with subtle border (1px solid rgba(0,0,0,0.08))
     - Aspect ratio: 1:1.2 (width:height) for visual consistency
   
   - **Logo & Branding:**
     - Logo container: 80px × 80px circular with subtle inner shadow
     - Fallback initials: 2-letter monogram in brand gradient background
     - Logo loading state: Shimmer placeholder with agency initials
     - Image optimization: WebP format with JPEG fallback, lazy loading
   
   - **Typography Hierarchy:**
     - Agency name: Font-weight 600, 18px (mobile) / 20px (desktop), line-height 1.3
     - Coverage areas: Font-weight 400, 14px, text-gray-600, truncated elegantly
     - Character limit: 45 chars with intelligent word-break, tooltip on hover
   
   - **Specialisms Tags:**
     - Design: Pill-shaped tags with subtle background (bg-gray-50, border-gray-200)
     - Typography: 12px font-weight 500, letter-spacing 0.025em
     - Color coding: Industry-specific colors (Office: blue-50, Retail: green-50, etc.)
     - Layout: Flex wrap with 4px gap, maximum 3 visible + "+X more" indicator
   
   - **Interactive States:**
     - Hover: Transform scale(1.02) with 300ms ease-out transition
     - Active: Transform scale(0.98) with 150ms ease-in
     - Focus: 2px solid focus ring with brand color
     - Loading: Skeleton with pulsing animation, maintaining card dimensions
   
   - **Mobile Optimization:**
     - Touch targets: Minimum 48px (exceeding 44px standard)
     - Spacing: 16px padding internal, 12px gap between cards
     - Stacked layout: Full-width cards on mobile with optimized vertical spacing
     - Gesture support: Subtle spring animation on tap

### Integration Requirements:
5. Existing navigation functionality unchanged except for new link addition
6. Follow existing card component patterns from listing cards
7. Use existing loading states and error handling patterns
8. Maintain current responsive breakpoints

### Quality Requirements:
9. Page loads in under 2 seconds
10. Accessibility: Proper heading hierarchy, alt text for logos, WCAG 2.1 AA compliance
11. SEO: Static generation where possible, proper meta tags
12. Empty state: "No agencies yet" with CTA when directory is empty
13. Mobile: Responsive grid (1 column mobile, 2 tablet, 3 desktop)
14. Touch-friendly: 44px minimum touch targets, adequate spacing
15. Loading states: Skeleton UI during initial load and pagination

## Technical Notes

### Implementation Approach:
```typescript
// Database migrations
- /supabase/migrations/020_create_agency_tables.sql

// New components
- /app/agents/page.tsx - Main directory page
- /components/agency/AgencyCard.tsx - Card component
- /components/agency/AgencyGrid.tsx - Grid layout wrapper

// Modified components
- /components/header.tsx - Add Agents link
```

### Key Constraints:
- Use Supabase client-side queries for initial implementation
- Logos stored in existing 'logos' storage bucket
- Coverage areas stored as TEXT field (500 character limit)
- Specialisms as JSONB array matching existing property types
- Touch targets minimum 44px for mobile compliance

### Sample Database Schema:
```sql
CREATE TABLE agencies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  logo_url TEXT,
  coverage_areas TEXT, -- Free text field for coverage description
  specialisms JSONB DEFAULT '[]'::jsonb,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('draft', 'pending', 'approved', 'rejected')),
  admin_notes TEXT, -- For rejection reasons or internal notes
  created_by UUID REFERENCES users(id) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  approved_at TIMESTAMPTZ,
  approved_by UUID REFERENCES users(id)
);

-- Version tracking for agency changes
CREATE TABLE agency_versions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  agency_id UUID REFERENCES agencies(id) ON DELETE CASCADE,
  version_number INTEGER NOT NULL,
  data JSONB NOT NULL, -- Complete snapshot of agency data
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('draft', 'pending', 'approved', 'rejected')),
  admin_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id) NOT NULL,
  reviewed_at TIMESTAMPTZ,
  reviewed_by UUID REFERENCES users(id),
  UNIQUE(agency_id, version_number)
);

CREATE TABLE agency_agents (
  agency_id UUID REFERENCES agencies(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id), -- Nullable for manually added agents
  email TEXT NOT NULL, -- For both registered users and manual entries
  name TEXT NOT NULL,
  phone TEXT,
  coverage_area TEXT,
  headshot_url TEXT,
  role TEXT CHECK (role IN ('admin', 'member')),
  is_registered BOOLEAN DEFAULT FALSE, -- True if user_id exists
  invitation_token TEXT UNIQUE,
  invitation_expires_at TIMESTAMPTZ,
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (agency_id, email) -- Use email as primary identifier
);
```

## Definition of Done
- [ ] Database migrations deployed and tested
- [ ] Agent directory page renders with test data
- [ ] Navigation updated with working Agents link
- [ ] Agency cards display all required information
- [ ] Responsive design verified on mobile/tablet/desktop
- [ ] Page performance meets < 2s load time
- [ ] Accessibility audit passed
- [ ] Unit tests for new components
- [ ] E2E test for navigation to agents page

## Estimates
- **Development:** 6-8 hours
- **Testing:** 2 hours
- **Total:** 8-10 hours

## Dependencies
- No external dependencies
- Can proceed immediately

## Edge Cases & Error Handling
- **No agencies exist**: Show empty state with contextual CTA (conditional for non-agency users)
- **Network failures**: Show retry button with error message
- **Logo load failures**: Fallback to agency initials
- **Long agency names**: Truncate at 40 characters with tooltip
- **No specialisms**: Show "General Commercial" as default
- **Search no results**: Clear messaging with suggestion to browse all

## User Experience Consistency
- **Non-Agency Users**: Clean, uncluttered experience - see directory without agency pressure
- **Agency Members**: See directory with their agency highlighted, no "Add Agency" CTAs
- **Non-Agency Interested**: See contextual CTAs that can be dismissed permanently
- **User Preference Tracking**: Store user's agency interest preference to avoid repeated prompts

## Premium UX Micro-Interactions
- **Page Load:** Staggered card entrance animations (100ms delays)
- **Search Interactions:** Smooth focus states with subtle shadow expansion  
- **Hover Feedback:** Cards lift with smooth shadow transitions
- **Touch Feedback:** Haptic-style spring animations on mobile taps
- **Loading States:** Skeleton shimmer with branded accent color
- **Empty States:** Illustrated graphics with encouraging messaging

## Accessibility & Performance
- **Keyboard Navigation:** Full tab order with visible focus indicators
- **Screen Readers:** Comprehensive ARIA labels and landmarks
- **Color Contrast:** WCAG AA compliance (4.5:1 minimum)
- **Motion Preferences:** Respects reduce-motion system preferences
- **Image Loading:** Progressive enhancement with blur-up technique
- **Performance Budget:** <2s load time with lazy loading implementation

## Notes
- This story sets up the foundation only
- Agency detail pages will be implemented in subsequent stories
- Search/filter functionality will be enhanced in future iterations
- Consider adding analytics tracking for directory views
- Mobile-first responsive design approach required
- **Design System Integration:** All components align with existing brand guidelines