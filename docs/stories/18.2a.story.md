# Story 18.2a: Agency Edit View

## Status: Ready

## Story

As an **agency owner**,
I want **to edit my agency profile using an interface similar to the public view**,
So that **I can see exactly how my changes will appear to visitors while editing**.

## Story Context

**Existing System Integration:**
- Integrates with: Agency creation flow, public agency profile view
- Technology: Next.js 14, React, TypeScript, Supabase real-time
- Follows pattern: Similar to listing detail edit page (`/occupier/listing/[id]`)
- Touch points: Agency data model, file uploads, team management

## Acceptance Criteria

**Functional Requirements:**

1. **Edit View Access**:
   - Route: `/agencies/[id]/edit`
   - Only accessible by agency owner (creator)
   - Redirect to 404 if not authorized
   - Show draft/pending/approved status badge

2. **Layout Matching Public View**:
   - Exact same layout as public agency profile
   - Each section has edit controls when hovered
   - Visual indication of editable areas
   - "Preview" toggle to hide edit controls

3. **Inline Editing Capabilities**:
   - **Header Section**:
     - Click to edit agency name
     - Click to upload/change logo
     - Edit classification dropdown
     - Edit geographic patch
   - **Description Section**:
     - Click to edit description (rich text or plain)
     - Character counter (500 limit)
     - Auto-save on blur
   - **Contact Section**:
     - Edit email, phone, website
     - Validation on blur
   - **Office Location Section**:
     - Click to add/edit office address
     - Location search with autocomplete (using Mapbox)
     - Fields: Street address, City, Postcode, Country
     - Map preview showing office location
     - Option to add coordinates manually
     - "Use this as primary office" checkbox
   
4. **Team Member Management**:
   - "Add Team Member" button in team section
   - Edit button on each team member card
   - Delete with confirmation
   - Drag to reorder (desktop)
   - Up/down buttons (mobile)

5. **Auto-Save Behavior**:
   - Save indicator in header
   - Debounced saves (2 seconds after changes)
   - Optimistic updates
   - Error recovery on save failure

6. **Submit for Review**:
   - Persistent floating button or header button
   - Shows "Submit for Review" if draft
   - Shows "Submit Changes" if editing approved version
   - Validation before submission
   - Confirmation modal with summary of changes

**Mobile Considerations:**

7. Touch-friendly edit controls
8. Responsive modal forms for complex edits
9. Swipe actions for delete (with confirmation)

## Technical Notes

**Component Structure:**
```
/app/agencies/[id]/edit/page.tsx - Edit page
/components/agency/AgencyEditView.tsx - Main edit component
/components/agency/EditableSection.tsx - Wrapper for editable areas
/components/agency/InlineEdit.tsx - Inline editing component
/components/agency/TeamMemberEditModal.tsx - Team member form
/components/agency/OfficeLocationEdit.tsx - Office location editor
/hooks/useAutoSave.ts - Auto-save hook
```

**State Management:**
```typescript
interface AgencyEditState {
  agency: Agency;
  isDirty: boolean;
  isSaving: boolean;
  lastSaved: Date | null;
  errors: ValidationError[];
}

interface OfficeLocation {
  id?: string;
  street_address: string;
  city: string;
  postcode: string;
  country: string;
  coordinates?: {
    lat: number;
    lng: number;
  };
  is_primary: boolean;
}

// Optimistic updates
const updateField = (field: string, value: any) => {
  // Update local state immediately
  setAgency(prev => ({ ...prev, [field]: value }));
  // Trigger debounced save
  debouncedSave();
};
```

**Auto-Save Implementation:**
```typescript
const useAutoSave = (agency: Agency) => {
  const [isSaving, setIsSaving] = useState(false);
  
  const save = useCallback(async () => {
    setIsSaving(true);
    try {
      await updateAgency(agency.id, agency);
      setLastSaved(new Date());
    } catch (error) {
      toast.error('Failed to save changes');
    } finally {
      setIsSaving(false);
    }
  }, [agency]);
  
  const debouncedSave = useMemo(
    () => debounce(save, 2000),
    [save]
  );
  
  return { debouncedSave, isSaving };
};
```

**Edit Controls Pattern:**
```tsx
<EditableSection
  onEdit={() => setEditing(true)}
  isEditing={editing}
>
  {editing ? (
    <InlineEdit
      value={agency.description}
      onChange={(value) => updateField('description', value)}
      maxLength={500}
    />
  ) : (
    <p>{agency.description || 'Click to add description'}</p>
  )}
</EditableSection>
```

**Office Location Component:**
```tsx
<OfficeLocationEdit
  location={agency.office_location}
  onChange={(location) => updateField('office_location', location)}
  onSearch={searchMapboxLocations}
>
  <div className="space-y-2">
    <LocationSearch
      placeholder="Search for office address..."
      onSelect={(place) => setOfficeFromMapbox(place)}
    />
    <div className="grid grid-cols-2 gap-2">
      <Input 
        placeholder="Street address"
        value={location.street_address}
      />
      <Input 
        placeholder="Postcode" 
        value={location.postcode}
      />
    </div>
    {location.coordinates && (
      <MapPreview 
        lat={location.coordinates.lat}
        lng={location.coordinates.lng}
      />
    )}
  </div>
</OfficeLocationEdit>
```

## Definition of Ready

- [x] Acceptance criteria defined
- [x] Technical approach documented
- [x] Edit patterns defined
- [ ] UI mockups approved
- [ ] Auto-save strategy confirmed
- [ ] Story pointed by team

## Definition of Done

- [ ] Edit view implemented matching public layout
- [ ] All inline editing functional
- [ ] Team management working
- [ ] Auto-save with indicators
- [ ] Submit for review flow complete
- [ ] Permission checks enforced
- [ ] Mobile responsive
- [ ] Optimistic updates working
- [ ] Error handling implemented
- [ ] Unit tests >80% coverage
- [ ] E2E tests for edit flows
- [ ] Documentation updated
- [ ] Deployed to staging
- [ ] Product Owner sign-off