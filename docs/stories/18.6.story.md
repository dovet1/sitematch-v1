# Story 18.6: Listing-Agency Linking System

## Status: Ready

## Story

As a **listing creator**,
I want **to link my listings to our agency**,
So that **our agency gets visibility and attribution for the properties we represent**.

## Story Context

**Existing System Integration:**
- Integrates with: Listing creation/edit system, agency profiles, company carousel
- Technology: Next.js 14, React, TypeScript, Supabase
- Follows pattern: Similar to existing listing field relationships
- Touch points: Listing forms, database schema, agency profile display

## Acceptance Criteria

**Functional Requirements:**

1. **Agency Selection in Listing**:
   - Add "Agency" field to listing create/edit forms
   - Autocomplete search for approved agencies only
   - Display agency logo next to selected name
   - Optional field (nullable)
2. **Search Functionality**:
   - Type-ahead search with 300ms debounce
   - Search by agency name
   - Show maximum 10 results
   - Keyboard navigation support
   - "Can't find your agency? Create it" option at bottom of results
3. **Create Agency Prompt**:
   - When no search results found, show prominent "Create Agency" button
   - If user clicks "Create Agency":
     - Open quick creation modal (from Story 18.2)
     - After creation, auto-select the new agency
     - Return user to listing form with agency pre-filled
   - Show message: "Agency created and linked to this listing"
4. **Linking Behavior**:
   - Save `linked_agency_id` to listings table
   - Update triggers refresh of agency's "Companies We Work With"
   - Maintain link through listing versions
5. **Unlinking**:
   - Clear button to remove agency association
   - Confirmation dialog for unlinking
   - Updates reflected immediately in agency profile
6. **Display on Listing**:
   - Show linked agency on public listing view
   - Click to navigate to agency profile
   - Display agency logo and name

**Data Integrity Requirements:**

7. Only link to approved agencies (except newly created which auto-links)
8. Handle agency deletion gracefully (soft delete or cascade)
9. Bulk linking tool for admins (separate story)
10. Audit trail for link/unlink actions

**Permission Requirements:**

11. Listing creator can link/unlink their own listings
12. Admin can link/unlink any listing
13. Agency cannot self-link to listings they don't own
14. User creating agency through listing flow becomes agency owner

## Technical Notes

**Database Changes:**
```sql
ALTER TABLE listings 
ADD COLUMN linked_agency_id UUID REFERENCES agencies(id) ON DELETE SET NULL;

CREATE INDEX idx_listings_linked_agency ON listings(linked_agency_id);

-- Audit table
CREATE TABLE listing_agency_audit (
  id UUID PRIMARY KEY,
  listing_id UUID NOT NULL,
  agency_id UUID,
  action VARCHAR(20), -- 'linked' or 'unlinked'
  performed_by UUID,
  performed_at TIMESTAMP
);
```

**API Endpoints:**
- `GET /api/agencies/search?q=` - Search approved agencies
- `PUT /api/listings/:id/link-agency` - Link agency to listing
- `DELETE /api/listings/:id/link-agency` - Unlink agency

**Component Updates:**
```typescript
// Agency selector with create option
<AgencySelector
  value={linkedAgencyId}
  onChange={setLinkedAgencyId}
  placeholder="Search for agency..."
  onCreateNew={() => setShowCreateAgencyModal(true)}
  renderNoResults={() => (
    <div className="p-4 text-center">
      <p className="text-sm text-gray-500 mb-2">
        No agencies found
      </p>
      <Button 
        onClick={() => setShowCreateAgencyModal(true)}
        variant="primary"
        size="sm"
      >
        <Plus className="w-4 h-4 mr-1" />
        Create Your Agency
      </Button>
    </div>
  )}
/>

// Create agency modal integration
{showCreateAgencyModal && (
  <QuickAgencyCreationModal
    onSuccess={(agencyId) => {
      setLinkedAgencyId(agencyId);
      setShowCreateAgencyModal(false);
      toast.success('Agency created and linked to listing');
    }}
    onClose={() => setShowCreateAgencyModal(false)}
  />
)}
```

**Cache Invalidation:**
- Clear agency profile cache on link/unlink
- Update search index with agency associations

## Definition of Ready

- [x] Acceptance criteria defined
- [x] Database schema changes defined
- [x] API endpoints specified
- [ ] Autocomplete component design approved
- [ ] Permission model confirmed
- [ ] Story pointed by team

## Definition of Done

- [ ] Database migration completed
- [ ] Agency selector component built
- [ ] Autocomplete search working
- [ ] Link/unlink functionality complete
- [ ] Agency profile updates automatically
- [ ] Permissions enforced
- [ ] Audit logging implemented
- [ ] Unit tests >80% coverage
- [ ] Integration tests for linking flow
- [ ] Performance testing for search
- [ ] Documentation updated
- [ ] Deployed to staging
- [ ] Product Owner sign-off