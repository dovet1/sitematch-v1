# Story 3.2: Location Search & File Upload Integration

## Status: Draft

## Story

- As an **authenticated Occupier creating a listing**
- I want to search for UK/Ireland locations and upload PDF brochures
- so that I can specify my preferred locations and provide detailed company information to potential landlords

## Acceptance Criteria (ACs)

1. **Location Search Integration**: Integrate Mapbox Places API for UK/Ireland location search and selection
2. **File Upload System**: Implement secure PDF brochure upload to Supabase Storage with validation
3. **Location Management**: Allow multiple location selections with preferred/acceptable designation
4. **File Validation**: Validate PDF format, file size limits, and provide user feedback
5. **Storage Security**: Implement proper storage policies for authenticated file access
6. **Integration with Wizard**: Seamlessly integrate location search and file upload into existing wizard
7. **Error Handling**: Comprehensive error handling for API failures and file upload issues

## User Prerequisites

Before development begins, the user must complete these setup tasks:

### External Service Configuration
1. **Mapbox Account Setup** (User Action Required):
   - Create Mapbox account at https://account.mapbox.com/
   - Generate API access token with Geocoding API access
   - Provide `NEXT_PUBLIC_MAPBOX_TOKEN` environment variable to development team
   - Verify API key has UK/Ireland geocoding permissions

2. **Supabase Storage Configuration** (User Action Required):
   - Access Supabase dashboard and navigate to Storage section
   - Create new storage bucket named "brochures" with private access
   - Confirm storage policies will be implemented by development team
   - Verify storage quota is sufficient for expected PDF uploads (recommend 1GB minimum)

### Development Prerequisites
3. **Environment Variables**: Confirm all required environment variables are set:
   - `NEXT_PUBLIC_MAPBOX_TOKEN`: Mapbox API key for location search
   - `SUPABASE_URL` and `SUPABASE_ANON_KEY`: Already configured in previous stories

4. **File Upload Requirements**: Approve file upload specifications:
   - Maximum file size: 10MB per PDF
   - Allowed file types: PDF only for brochures
   - Storage retention policy: Files retained until listing deletion

## Tasks / Subtasks

- [ ] Task 0: Mapbox Integration Setup (AC: 1, 3)
  - [ ] Configure Mapbox Places API integration
  - [ ] Create location search utility functions
  - [ ] Implement location autocomplete component
  - [ ] Add UK/Ireland geographic boundary filtering
  - [ ] Test location search and selection flow

- [ ] Task 1: Location Search Components (AC: 1, 3)
  - [ ] Create LocationSearch component with autocomplete
  - [ ] Implement location selection list with preferred/acceptable options
  - [ ] Add location removal and reordering functionality
  - [ ] Style location components with shadcn/ui
  - [ ] Add location validation (minimum 1 location required)

- [ ] Task 2: File Upload System Setup (AC: 2, 5)
  - [ ] Configure Supabase Storage bucket for brochure uploads
  - [ ] Implement storage security policies for authenticated uploads
  - [ ] Create file upload utility functions with validation
  - [ ] Add PDF mime type validation and file size limits
  - [ ] Test file upload flow with error handling

- [ ] Task 3: File Upload Components (AC: 2, 4)
  - [ ] Create BrochureUpload component with drag & drop
  - [ ] Add file validation feedback and progress indicators
  - [ ] Implement file preview and replacement functionality
  - [ ] Add upload retry mechanism for failed uploads
  - [ ] Test file upload UX across different browsers

- [ ] Task 4: Wizard Integration (AC: 6)
  - [ ] Integrate LocationSearch into Step 2 (Requirement Details)
  - [ ] Integrate BrochureUpload into Step 1 (Company Information)
  - [ ] Update wizard form state to handle location and file data
  - [ ] Modify form validation to include location and file requirements
  - [ ] Test complete wizard flow with location and file data

- [ ] Task 5: Error Handling & Edge Cases (AC: 7)
  - [ ] Handle Mapbox API failures gracefully
  - [ ] Implement file upload error recovery
  - [ ] Add network connectivity checks
  - [ ] Handle large file upload timeouts
  - [ ] Test error scenarios and user feedback

- [ ] Task 6: Integration Testing (AC: 1-7)
  - [ ] End-to-end testing of location search flow
  - [ ] File upload testing with various file types and sizes
  - [ ] Error scenario testing (network failures, API limits)
  - [ ] Performance testing for large file uploads
  - [ ] Cross-browser compatibility testing

## Definition of Ready

- [ ] Mapbox account created and API key provided
- [ ] Supabase Storage configured and tested
- [ ] File upload requirements and limits defined
- [ ] Story 3.1 (Wizard UI) completed
- [ ] Integration specifications approved

## Definition of Done

- [ ] Location search working with UK/Ireland filtering
- [ ] File upload system implemented with proper validation
- [ ] Components integrated into existing wizard
- [ ] Error handling comprehensive and user-friendly
- [ ] Security policies tested and verified
- [ ] Unit and integration tests passing
- [ ] Performance requirements met

## Dev Technical Guidance

### Mapbox Integration Requirements

**Environment Variables**:
```bash
NEXT_PUBLIC_MAPBOX_TOKEN=pk.your_mapbox_token_here
```

**Location Search API Integration**:
```typescript
// /apps/web/src/lib/mapbox.ts
const MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_TOKEN;

export async function searchLocations(query: string): Promise<LocationResult[]> {
  const response = await fetch(
    `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?` +
    `access_token=${MAPBOX_TOKEN}&` +
    `country=GB,IE&` +
    `types=place,locality,neighborhood&` +
    `limit=5`
  );
  
  if (!response.ok) {
    throw new Error('Location search failed');
  }
  
  const data = await response.json();
  return data.features.map(feature => ({
    id: feature.id,
    place_name: feature.place_name,
    center: feature.center,
    place_type: feature.place_type
  }));
}

export interface LocationResult {
  id: string;
  place_name: string;
  center: [number, number]; // [lng, lat]
  place_type: string[];
}
```

### File Upload System Requirements

**Supabase Storage Configuration**:
```sql
-- Create storage bucket for brochures
INSERT INTO storage.buckets (id, name, public) VALUES ('brochures', 'brochures', false);

-- Storage policies
CREATE POLICY "Authenticated users can upload brochures" ON storage.objects
  FOR INSERT TO authenticated
  WITH CHECK (bucket_id = 'brochures');

CREATE POLICY "Users can view own org brochures" ON storage.objects
  FOR SELECT TO authenticated
  USING (bucket_id = 'brochures');

CREATE POLICY "Users can update own org brochures" ON storage.objects
  FOR UPDATE TO authenticated
  USING (bucket_id = 'brochures');
```

**File Upload Utility**:
```typescript
// /apps/web/src/lib/file-upload.ts
export async function uploadBrochure(file: File, orgId: string): Promise<string> {
  // Validate file
  if (file.type !== 'application/pdf') {
    throw new Error('Only PDF files are allowed');
  }
  
  if (file.size > 10 * 1024 * 1024) { // 10MB limit
    throw new Error('File size must be less than 10MB');
  }
  
  const fileExt = 'pdf';
  const fileName = `${orgId}/${Date.now()}.${fileExt}`;
  
  const { data, error } = await supabase.storage
    .from('brochures')
    .upload(fileName, file, {
      cacheControl: '3600',
      upsert: false
    });
    
  if (error) throw error;
  
  // Get public URL
  const { data: { publicUrl } } = supabase.storage
    .from('brochures')
    .getPublicUrl(data.path);
    
  return publicUrl;
}
```

### Component Integration

**Updated Wizard Form Data**:
```typescript
interface WizardFormData {
  // Step 1: Company Information
  companyName: string;
  companyDescription?: string;
  contactEmail: string;
  contactPhone?: string;
  brochureFile?: File;
  brochureUrl?: string;
  
  // Step 2: Requirement Details
  title: string;
  description?: string;
  sector: string;
  useClass: string;
  siteSizeMin?: number;
  siteSizeMax?: number;
  locations: LocationSelection[];
}

interface LocationSelection {
  id: string;
  place_name: string;
  coordinates: [number, number];
  type: 'preferred' | 'acceptable';
}
```

### File Locations

- **Mapbox Utils**: `/apps/web/src/lib/mapbox.ts`
- **File Upload Utils**: `/apps/web/src/lib/file-upload.ts`
- **Location Search Component**: `/apps/web/src/components/listings/location-search.tsx`
- **File Upload Component**: `/apps/web/src/components/listings/brochure-upload.tsx`
- **Storage Migration**: `/supabase/migrations/006_storage_policies.sql`
- **Types**: `/apps/web/src/types/locations.ts`, `/apps/web/src/types/uploads.ts`

## Testing Requirements

- [ ] Jest Unit Tests: location search and file upload utilities
- [ ] Component Tests: location and file upload components
- [ ] Integration Tests: complete wizard flow with location and file data
- [ ] E2E Tests: location: `/e2e/listing-creation-full.spec.ts`

## Dependencies

**Required Completed Stories**:
- **Story 1.0** (Project Bootstrap) - for complete development environment
- **Story 2.0** (User Authentication) - for occupier role authentication
- **Story 3.0** (Database Schema) - for listing data structure
- **Story 3.1** (Wizard UI) - for form components to integrate with

**Blocked By**:
- Story 3.1 must be completed before this story can be implemented

## External Dependencies

- **Mapbox Account**: API key required for location search
- **Supabase Storage**: Bucket configuration required for file uploads

## Estimated Effort

**Story Points**: 8
**Sprint Capacity**: 1-2 sprints (8-12 days)

## Risk Assessment

**High Risk Areas**:
- Mapbox API rate limiting and error handling
- Large file upload performance and timeout handling
- Cross-browser file upload compatibility

**Mitigation Strategies**:
- Implement proper API error handling and fallbacks
- Add file upload progress indicators and retry mechanisms
- Test thoroughly across different browsers and devices

## Dev Agent Record

[To be filled during implementation]

## QA Results

[To be filled during implementation]