# Story 2.1: Landlord Email Capture

## Status: Approved - Ready after Stories 1.0 & 2.0

## Story

- As a **Landlord/Agent/Investor/Vendor** visitor
- I want to be prompted to share my email and role when I first visit the site
- so that I can receive relevant property opportunities and updates via newsletter

## Acceptance Criteria (ACs)

1. **Modal Trigger**: First page-view triggers a modal requesting email and role selection
2. **Form Validation**: Email field must be validated for proper format
3. **Role Selection**: Radio buttons offer "Agent / Investor / Landlord / Vendor" options
4. **Data Storage**: Accept stores data in `public.leads` table and subscribes to marketing newsletter
5. **Graceful Decline**: Decline allows anonymous browsing without re-prompt for 30 days
6. **localStorage Control**: Re-prompt logic uses localStorage flag for 30-day tracking

## User Prerequisites

Before development begins, the user must:
1. **Resend Account**: Create Resend account and obtain API key
2. **Audience Setup**: Create "Property Leads" audience in Resend dashboard
3. **Environment Config**: Provide RESEND_API_KEY and RESEND_AUDIENCE_ID values

## Tasks / Subtasks

- [ ] Task 0: Database Schema Setup (AC: 4)
  - [ ] Create `public.leads` table using provided SQL schema
  - [ ] Apply RLS policies for anonymous insert and service role read
  - [ ] Create and run Supabase migration file
  - [ ] Verify table creation and permissions in Supabase dashboard

- [ ] Task 1: Newsletter Service Setup (AC: 4)
  - [ ] Create Resend audience for "Property Leads"
  - [ ] Configure environment variables (RESEND_API_KEY, RESEND_AUDIENCE_ID)
  - [ ] Create newsletter integration utility functions
  - [ ] Test newsletter subscription with sample data

- [ ] Task 2: Create LeadCaptureModal component (AC: 1, 2, 3)
  - [ ] Build modal component using shadcn/ui Dialog
  - [ ] Implement email validation with react-hook-form
  - [ ] Add radio button group for persona selection
  - [ ] Style modal according to project TailwindCSS standards

- [ ] Task 3: Implement localStorage tracking logic (AC: 5, 6)
  - [ ] Create utility functions for localStorage management
  - [ ] Implement 30-day tracking logic
  - [ ] Handle localStorage cleanup and expiration

- [ ] Task 4: Create lead capture API endpoint (AC: 4)
  - [ ] Build Next.js route handler at `/api/leads`
  - [ ] Integrate with Supabase to insert into `public.leads` table
  - [ ] Integrate newsletter subscription with graceful error handling
  - [ ] Implement proper validation and error responses

- [ ] Task 5: Integrate modal with root layout (AC: 1)
  - [ ] Add modal to app layout for first-time visitors only
  - [ ] Implement trigger logic based on localStorage check
  - [ ] Ensure modal appears on page load, not route change

- [ ] Task 6: Add comprehensive testing
  - [ ] Unit tests for lead capture logic and newsletter integration
  - [ ] Integration tests for API endpoint with database
  - [ ] E2E tests for complete user flow including error scenarios

## Dev Technical Guidance

### Previous Story Insights
**Dependencies**: This story requires:
- **Story 1.0** (Project Bootstrap) - for complete development environment
- **Story 2.0** (User Authentication) - for foundational auth system that enables future admin/occupier features

### Data Models
**`public.leads` table structure** [Source: architecture/3-domain-model-er-excerpt.md]:
```sql
leads (id PK, email, persona {agent|investor|landlord|vendor}, created_at)
```

### Database Schema Requirements
**`public.leads` table creation SQL** [Source: architecture/3-domain-model-er-excerpt.md]:
```sql
CREATE TABLE public.leads (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  email text NOT NULL UNIQUE,
  persona text NOT NULL CHECK (persona IN ('agent', 'investor', 'landlord', 'vendor')),
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- RLS Policies
ALTER TABLE public.leads ENABLE ROW LEVEL SECURITY;

-- Allow anonymous inserts (for lead capture)
CREATE POLICY "Allow anonymous lead creation" ON public.leads
  FOR INSERT TO anon
  WITH CHECK (true);

-- Allow service role to read all leads (for admin/analytics)
CREATE POLICY "Allow service role read access" ON public.leads
  FOR SELECT TO service_role
  USING (true);
```

**Migration File Location**: `/supabase/migrations/001_create_leads_table.sql`

### API Specifications
No specific API endpoint defined in architecture docs for lead capture, but should follow pattern:
- **POST** `/api/leads` - create new lead entry
- Request body: `{ email: string, persona: 'agent'|'investor'|'landlord'|'vendor' }`
- Response: `{ success: boolean, message?: string }`

### Component Specifications
**Modal Component Requirements**:
- Use **shadcn/ui Dialog** component [Source: architecture/2-tech-stack.md - shadcn/ui component library]
- **React Hook Form** for form management [Source: architecture/coding-standards.md - React 18 functional components with hooks]
- **TailwindCSS** for styling [Source: architecture/2-tech-stack.md]
- **TypeScript** for all code [Source: architecture/coding-standards.md]

### Newsletter Service Integration
**Resend Integration Requirements** [Source: architecture/2-tech-stack.md - Resend for transactional email]:

- **Environment Variables Required**:
  - `RESEND_API_KEY` - Resend API key for server-side requests
  - `RESEND_AUDIENCE_ID` - Target audience ID for property leads

- **API Integration Pattern**:
```typescript
// Add to /apps/web/src/lib/resend.ts
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

export async function subscribeToNewsletter(email: string, persona: string) {
  try {
    await resend.contacts.create({
      email,
      audienceId: process.env.RESEND_AUDIENCE_ID!,
      tags: [persona, 'lead-capture']
    });
    return { success: true };
  } catch (error) {
    console.error('Newsletter subscription failed:', error);
    return { success: false, error: error.message };
  }
}
```

- **Error Handling Strategy**: Newsletter subscription failures should NOT prevent lead storage in database
- **User Experience**: Show success message even if newsletter fails (log error for admin review)

### File Locations
Based on project structure [Source: source-tree.md]:
- **Database Migration**: `/supabase/migrations/001_create_leads_table.sql`
- **Newsletter Utility**: `/apps/web/src/lib/resend.ts`
- **Modal Component**: `/apps/web/src/components/lead-capture-modal.tsx`
- **API Route**: `/apps/web/src/app/api/leads/route.ts`
- **Utility Functions**: `/apps/web/src/lib/lead-capture.ts`
- **Type Definitions**: `/apps/web/src/types/leads.ts`

### Testing Requirements
**Testing Strategy** [Source: architecture/coding-standards.md]:
- **Jest** for unit testing
- **Playwright** for E2E testing
- All changes require automated testing to pass

### Technical Constraints
- **Supabase Integration**: Use Supabase client for database operations [Source: architecture/2-tech-stack.md]
- **Next.js 14 App Router**: Route handlers for API endpoints [Source: architecture/4-api-surface.md]
- **TypeScript strict mode** enabled [Source: architecture/coding-standards.md]
- **Row Level Security**: Ensure proper RLS policies for `public.leads` table [Source: architecture/coding-standards.md]

### Testing

Dev Note: Story Requires the following tests:

- [ ] Jest Unit Tests: (nextToFile: true), coverage requirement: 80%
- [ ] Jest Integration Test: location: `/apps/web/src/app/api/leads/route.test.ts`
- [ ] Playwright E2E: location: `/e2e/lead-capture.test.ts`

Manual Test Steps:
- Visit site in incognito mode
- Verify modal appears on first page load
- Test email validation with invalid formats
- Test all persona radio button selections
- Submit form and verify success message
- Decline modal and verify no re-prompt for 30 days
- Clear localStorage and verify modal reappears

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (SM Agent) When Drafting Story, leave next prompt in place for dev agent to remove and update]]
[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

[[LLM: (SM Agent) When Drafting Story, leave next prompt in place for dev agent to remove and update - remove this line to the SM]]
[[LLM: (Dev Agent) Anything the SM needs to know that deviated from the story that might impact drafting the next story.]]

### File List

[[LLM: (Dev Agent) List every new file created, or existing file modified in a bullet list.]]

### Change Log

[[LLM: (SM Agent) When Drafting Story, leave next prompt in place for dev agent to remove and update- remove this line to the SM]]
[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |

## QA Results

[[LLM: QA Agent Results]]